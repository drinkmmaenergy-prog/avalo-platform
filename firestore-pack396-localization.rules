/**
 * PACK 396: Global Translation, Localization & Cultural Adaptation Engine
 * Firestore Security Rules
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.roles.hasAny(['super_admin', 'translator_admin']);
    }
    
    function isTranslator() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/translators/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/translators/$(request.auth.uid)).data.active == true;
    }
    
    function hasTranslatorRole(locale) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/translators/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/translators/$(request.auth.uid)).data.locales.hasAny([locale]);
    }
    
    // Translations - Live (Public Read, Admin Write)
    match /translations_live/{translationId} {
      allow read: if true; // Public read for all translations
      allow write: if isAdmin();
    }
    
    // Translation Versions (Admin Only)
    match /translations_versions/{versionId} {
      allow read: if isAdmin() || isTranslator();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Culture Rules (Public Read, Admin Write)
    match /culture_rules/{ruleId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Legal Documents by Country (Public Read, Admin Write)
    match /legal_country_versions/{docId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Store Localizations (Public Read, Admin Write)
    match /store_localizations/{localizationId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Translation Audit Logs (Admin Only)
    match /translation_audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if false; // Immutable
      allow delete: if false; // Never delete audit logs
    }
    
    // Translator Accounts (Admin + Self)
    match /translators/{translatorId} {
      allow read: if isAdmin() || request.auth.uid == translatorId;
      allow create: if isAdmin();
      allow update: if isAdmin() || (request.auth.uid == translatorId && 
                                    !request.resource.data.diff(resource.data).affectedKeys().hasAny(['locales', 'permissions', 'active']));
      allow delete: if isAdmin();
    }
    
    // Translation Work Queue (Translators)
    match /translation_queue/{taskId} {
      allow read: if isTranslator();
      allow create: if isAdmin();
      allow update: if isAdmin() || (isTranslator() && 
                                     hasTranslatorRole(resource.data.locale) &&
                                     request.resource.data.status in ['in_progress', 'completed', 'reviewed']);
      allow delete: if isAdmin();
    }
    
    // Translation Suggestions (Authenticated Users)
    match /translation_suggestions/{suggestionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || isTranslator();
      allow delete: if isAdmin();
    }
    
    // Missing Translation Reports (Generated by System)
    match /missing_translation_reports/{reportId} {
      allow read: if isAdmin() || isTranslator();
      allow write: if isAdmin();
    }
    
    // Locale Preferences (User-specific)
    match /users/{userId}/preferences/locale_settings {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Cultural Filter Logs (Admin Only, System Write)
    match /cultural_filter_logs/{logId} {
      allow read: if isAdmin();
      allow create: if true; // System can create
      allow update, delete: if false; // Immutable
    }
    
    // Store Asset Metadata (Admin Only)
    match /store_asset_metadata/{assetId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Multi-Currency Formats (Public Read, Admin Write)
    match /currency_formats/{currencyId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Regional Configs (Public Read, Admin Write)
    match /regional_configs/{regionId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
