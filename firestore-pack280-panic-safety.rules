rules_version = '2';

// PACK 280 â€” Panic & Live Safety Engine Firestore Rules

// Helper functions
function isAuthenticated() {
  return request.auth != null;
}

function isOwner(userId) {
  return isAuthenticated() && request.auth.uid == userId;
}

function isAdmin() {
  return isAuthenticated() && 
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

function isModerator() {
  return isAuthenticated() && 
    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'moderator');
}

function isParticipant(participants) {
  return isAuthenticated() && request.auth.uid in participants;
}

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Safety Profiles - users can read/write their own profile
    match /safetyProfiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) && 
        // Users can only modify their own fields, not system fields
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['userId', 'lastPanicAt']) ||
        // Allow creation of new profile
        !exists(/databases/$(database)/documents/safetyProfiles/$(userId));
    }
    
    // Live Sessions - participants can read their own sessions, admins can read all
    match /liveSessions/{sessionId} {
      allow read: if isParticipant(resource.data.participants) || isModerator();
      allow create: if isAuthenticated() && 
        request.resource.data.hostId == request.auth.uid ||
        request.resource.data.guestId == request.auth.uid;
      allow update: if isParticipant(resource.data.participants) ||
        isModerator();
      allow delete: if isModerator();
    }
    
    // Panic Events Log - read by participants and moderators, write via Cloud Functions
    match /panicEvents/{eventId} {
      allow read: if isOwner(resource.data.userId) || isModerator();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Trusted Contacts Notifications Log - read by owner and admins
    match /trustedContactNotifications/{notificationId} {
      allow read: if isOwner(resource.data.userId) || isModerator();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Safety Session Logs - read by participants and moderators
    match /safetySessionLogs/{logId} {
      allow read: if isOwner(resource.data.userId) || isModerator();
      allow write: if false; // Only via Cloud Functions
    }
  }
}