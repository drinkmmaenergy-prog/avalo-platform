rules_version = '2';

// PACK 273 â€” Full Chat Logic System
// Firestore Security Rules

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isChatParticipant(chatData) {
      return isAuthenticated() && 
             request.auth.uid in chatData.participants;
    }
    
    function isActiveAccount() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active';
    }
    
    // ============================================================================
    // PACK 273 CHATS
    // ============================================================================
    
    match /pack273_chats/{chatId} {
      // Read: Only participants can read
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      
      // Create: Authenticated users with active accounts
      allow create: if isAuthenticated() &&
                       isActiveAccount() &&
                       request.auth.uid in request.resource.data.participants &&
                       request.resource.data.participants.size() == 2 &&
                       request.resource.data.state == 'FREE_ACTIVE' &&
                       request.resource.data.messageCount == 0;
      
      // Update: Only participants can update
      allow update: if isAuthenticated() &&
                       request.auth.uid in resource.data.participants &&
                       // Prevent modifying core fields
                       request.resource.data.participants == resource.data.participants &&
                       request.resource.data.roles == resource.data.roles;
      
      // Delete: Never allow direct deletion (must use closePack273Chat)
      allow delete: if false;
    }
    
    // ============================================================================
    // PACK 273 MESSAGES
    // ============================================================================
    
    match /pack273_chats/{chatId}/messages/{messageId} {
      // Read: Only chat participants
      allow read: if isAuthenticated() && 
                     request.auth.uid in get(/databases/$(database)/documents/pack273_chats/$(chatId)).data.participants;
      
      // Create: Only participants can send messages
      allow create: if isAuthenticated() &&
                       request.auth.uid in get(/databases/$(database)/documents/pack273_chats/$(chatId)).data.participants &&
                       request.resource.data.senderId == request.auth.uid &&
                       request.resource.data.timestamp == request.time;
      
      // Update/Delete: Messages cannot be modified or deleted
      allow update, delete: if false;
    }
    
    // ============================================================================
    // COPY/PASTE TRACKING
    // ============================================================================
    
    match /pack273_copy_paste_tracking/{trackingId} {
      // Read: Users can read their own tracking data
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Create: System only (via backend)
      allow create: if false;
      
      // Update/Delete: Never
      allow update, delete: if false;
    }
    
    // ============================================================================
    // SAFETY INCIDENTS
    // ============================================================================
    
    match /safety_incidents/{incidentId} {
      // Read: Reporter or admin only
      allow read: if isAuthenticated() && 
                     (resource.data.reporterId == request.auth.uid ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true);
      
      // Create: Users can report (via backend validation)
      allow create: if isAuthenticated() &&
                       request.resource.data.reporterId == request.auth.uid;
      
      // Update/Delete: Admin only
      allow update, delete: if isAuthenticated() &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
    }
    
    // ============================================================================
    // MEDIA STORAGE METADATA
    // ============================================================================
    
    match /pack273_media/{mediaId} {
      // Read: Sender, receiver, or admin
      allow read: if isAuthenticated() && 
                     (resource.data.senderId == request.auth.uid ||
                      resource.data.receiverId == request.auth.uid ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true);
      
      // Create: Authenticated users (via backend validation)
      allow create: if isAuthenticated() &&
                       request.resource.data.senderId == request.auth.uid;
      
      // Update: Add blur/reveal status
      allow update: if isAuthenticated() &&
                       (request.resource.data.senderId == request.auth.uid ||
                        request.resource.data.receiverId == request.auth.uid);
      
      // Delete: Never allow direct deletion
      allow delete: if false;
    }
    
    // ============================================================================
    // CHAT STATISTICS (for UI display)
    // ============================================================================
    
    match /pack273_chat_stats/{userId} {
      // Read: User can read their own stats
      allow read: if isUser(userId);
      
      // Create/Update: System only
      allow create, update: if false;
      
      // Delete: Never
      allow delete: if false;
    }
  }
}