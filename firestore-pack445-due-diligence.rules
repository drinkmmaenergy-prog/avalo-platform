rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // PACK 445 â€“ Enterprise Readiness & Due Diligence Toolkit
    // Security Rules for External Access and Data Rooms
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isCFO() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'cfo'];
    }
    
    function isCTO() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'cto'];
    }
    
    function hasValidExternalToken(accessId) {
      let accessDoc = get(/databases/$(database)/documents/externalAccess/$(accessId));
      return accessDoc != null && 
             accessDoc.data.status == 'active' &&
             accessDoc.data.expiresAt > request.time;
    }
    
    // Due Diligence Data Rooms
    // Only admins can create, only authorized external parties can read
    match /dueDiligenceDataRooms/{dataRoomId} {
      // Admin can create and read
      allow create: if isAdmin();
      allow read: if isAdmin() || isCFO() || isCTO();
      
      // No updates or deletes - immutable record
      allow update, delete: if false;
    }
    
    // Enterprise Readiness Scores
    // Read-only for most, only system can write
    match /enterpriseReadinessScores/{scoreId} {
      allow read: if isAdmin() || isCFO() || isCTO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Audit Evidence
    // Highly restricted - auditors and admins only
    match /auditEvidence/{evidenceId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Canonical KPIs
    // Finance team and investors can read
    match /canonicalKPIs/{kpiId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // External Access Grants
    // Only admins can manage
    match /externalAccess/{accessId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false; // Never delete, only revoke
    }
    
    // Access Logs
    // Read-only audit trail
    match /accessLog/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    // System Logs (for audit assembly)
    match /systemLogs/{logId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Algorithmic Decisions (for audit assembly)
    match /algorithmicDecisions/{decisionId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Security Metrics
    match /securityMetrics/{metricId} {
      allow read: if isAdmin() || isCTO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Compliance Status
    match /complianceStatus/{statusId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Financial Metrics
    match /financialMetrics/{metricId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // MRR History
    match /mrrHistory/{dateId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Revenue Recognition
    match /revenueRecognition/{recordId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Data Subject Requests (GDPR)
    match /dataSubjectRequests/{requestId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // User Consents
    match /userConsents/{consentId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Security Breaches
    match /securityBreaches/{breachId} {
      allow read: if isAdmin() || isCTO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // PCI Compliance
    match /pciCompliance/{recordId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Legal Documents (policies)
    match /legalDocuments/{docId} {
      allow read: if true; // Public policies
      allow write: if isAdmin();
    }
    
    // Financial Reconciliation
    match /financialReconciliation/{recordId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Tax Documents
    match /taxDocuments/{docId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Subscription Upgrades
    match /subscriptionUpgrades/{upgradeId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Performance Metrics
    match /performanceMetrics/{metricId} {
      allow read: if isAdmin() || isCTO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Observability Metrics
    match /observabilityMetrics/{metricId} {
      allow read: if isAdmin() || isCTO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Monthly Transaction Summaries
    match /monthlyTransactionSummaries/{summaryId} {
      allow read: if isAdmin() || isCFO();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Active Users Metrics
    match /activeUsers/{periodId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Analytics
    match /analytics/{metricId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    // User Sessions
    match /userSessions/{sessionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only via Cloud Functions
    }
    
    // Expenses
    match /expenses/{expenseId} {
      allow read: if isAdmin() || isCFO();
      allow write: if isCFO();
    }
    
    // Financials
    match /financials/{recordId} {
      allow read: if isAdmin() || isCFO();
      allow write: if isCFO();
    }
    
    // CCPA Opt Outs
    match /ccpaOptOuts/{optOutId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}
