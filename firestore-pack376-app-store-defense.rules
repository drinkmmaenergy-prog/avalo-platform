rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // PACK 376: App Store Defense & Review System
    // ============================================
    
    // Store Reviews Collection
    match /storeReviews/{reviewId} {
      // Only system can write (via Cloud Functions)
      allow read: if request.auth != null && 
                     (resource.data.userId == request.auth.uid ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator']);
      
      allow create, update, delete: if false; // Only via Cloud Functions
    }
    
    // Review Threats Collection  
    match /reviewThreats/{threatId} {
      // Only admins and security team
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'security'];
      
      allow write: if false; // Only via Cloud Functions
    }
    
    // Review Signals Collection
    match /reviewSignals/{signalId} {
      // Only admins
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      allow write: if false; // Only via Cloud Functions
    }
    
    // User Trust Scores (sub-collection under users)
    match /users/{userId}/trustScore/{scoreId} {
      // Users can read their own, admins can read all
      allow read: if request.auth != null && 
                     (request.auth.uid == userId ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      allow write: if false; // Only via Cloud Functions
    }
    
    // ASO Metrics Collection
    match /asoMetrics/{metricId} {
      // Only admins and marketing team
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'marketing'];
      
      allow write: if false; // Only via Cloud Functions
    }
    
    // Review Request History (prevents spam)
    match /reviewRequests/{requestId} {
      // Users can read their own
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if false;
    }
    
    // Public Trust Signals (read-only for users)
    match /trustSignals/{signalId} {
      allow read: if request.auth != null;
      allow write: if false; // Only via Cloud Functions
    }
    
    // Reputation Metrics (global)
    match /reputationMetrics/{metricId} {
      // Admins only
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      allow write: if false; // Only via Cloud Functions
    }
  }
}
