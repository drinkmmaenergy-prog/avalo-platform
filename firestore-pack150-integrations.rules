rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // PACK 150: API Partner Profiles
    // Only admins can read/write
    match /api_partner_profiles/{partnerId} {
      allow read: if request.auth != null && 
                    (request.auth.token.admin == true || 
                     resource.data.apiKey == request.auth.token.apiKey);
      allow create: if request.auth != null && request.auth.token.admin == true;
      allow update: if request.auth != null && request.auth.token.admin == true;
      allow delete: if request.auth != null && request.auth.token.admin == true;
    }
    
    // API Integrations
    // Creators can read their own integrations
    // Partners can read integrations they're part of (with valid API key)
    // Admins can read all
    match /api_integrations/{integrationId} {
      allow read: if request.auth != null && 
                    (request.auth.token.admin == true ||
                     resource.data.creatorId == request.auth.uid);
      allow create: if request.auth != null && request.auth.token.admin == true;
      allow update: if request.auth != null && 
                      (request.auth.token.admin == true ||
                       resource.data.creatorId == request.auth.uid);
      allow delete: if request.auth != null && request.auth.token.admin == true;
    }
    
    // Integration Requests
    // Creators can read/update their own requests
    // Admins can read all
    match /integration_requests/{requestId} {
      allow read: if request.auth != null && 
                    (request.auth.token.admin == true ||
                     resource.data.creatorId == request.auth.uid);
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
                      (request.auth.token.admin == true ||
                       resource.data.creatorId == request.auth.uid);
      allow delete: if request.auth != null && request.auth.token.admin == true;
    }
    
    // Integration Consents
    // Creators can read/update their own consents
    // Admins can read all
    match /integration_consents/{consentId} {
      allow read: if request.auth != null && 
                    (request.auth.token.admin == true ||
                     resource.data.creatorId == request.auth.uid);
      allow create: if request.auth != null && 
                      (request.auth.token.admin == true ||
                       resource.data.creatorId == request.auth.uid);
      allow update: if request.auth != null && 
                      (request.auth.token.admin == true ||
                       resource.data.creatorId == request.auth.uid);
      allow delete: if request.auth != null && request.auth.token.admin == true;
    }
    
    // API Access Logs
    // Read-only for admins
    // No direct write access (written via Cloud Functions only)
    match /api_access_logs/{logId} {
      allow read: if request.auth != null && request.auth.token.admin == true;
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Integration Risk Cases
    // Read-only for admins and moderators
    // No direct write access (written via Cloud Functions only)
    match /integration_risk_cases/{caseId} {
      allow read: if request.auth != null && 
                    (request.auth.token.admin == true || 
                     request.auth.token.moderator == true);
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Partner Security Agreements
    // Read-only for authenticated users
    // Only admins can write
    match /partner_security_agreements/{agreementId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // Anonymized Datasets
    // Read-only with expiration check
    // No direct write access (written via Cloud Functions only)
    match /anonymized_datasets/{datasetId} {
      allow read: if request.auth != null && 
                    request.time < resource.data.expiresAt;
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Rate Limits
    // Read-only for partners and admins
    // No direct write access (written via Cloud Functions only)
    match /rate_limits/{partnerId} {
      allow read: if request.auth != null && 
                    (request.auth.token.admin == true ||
                     request.auth.token.apiKey != null);
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Helper Functions
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    function isModerator() {
      return request.auth != null && request.auth.token.moderator == true;
    }
    
    function isCreator(creatorId) {
      return request.auth != null && request.auth.uid == creatorId;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
  }
}