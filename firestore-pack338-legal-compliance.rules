rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // PACK 338: LEGAL COMPLIANCE ENGINE
    // ========================================
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // 1. LEGAL DOCUMENTS
    // ========================================
    match /legalDocuments/{docId} {
      // Anyone can read active legal documents
      allow read: if resource.data.isActive == true;
      
      // Only admins can create/update/delete legal documents
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // 2. LEGAL ACCEPTANCES (Immutable)
    // ========================================
    match /legalAcceptances/{acceptanceId} {
      // Users can read their own acceptances
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Users can only create acceptances for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'documentType', 'documentVersion', 'acceptedAt', 'ipAddress', 'countryCode']) &&
                       request.resource.data.acceptedAt is timestamp;
      
      // IMMUTABLE - No updates or deletes allowed
      allow update, delete: if false;
    }
    
    // ========================================
    // 3. USER COMPLIANCE STATUS
    // ========================================
    match /userComplianceStatus/{userId} {
      // Users can read their own status
      allow read: if isOwner(userId) || isAdmin();
      
      // Only system/admin can create or update compliance status
      allow create, update: if isAdmin();
      
      // No deletions allowed
      allow delete: if false;
    }
    
    // ========================================
    // 4. CONTENT STRIKES
    // ========================================
    match /contentStrikes/{strikeId} {
      // Users can read their own strikes
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Only system/admin can create strikes
      allow create: if isAdmin() &&
                       request.resource.data.keys().hasAll(['userId', 'source', 'ruleViolated', 'issuedAt', 'issuedBy', 'severity']) &&
                       request.resource.data.severity in [1, 2, 3] &&
                       request.resource.data.issuedAt is timestamp;
      
      // No updates or deletes allowed (immutable audit trail)
      allow update, delete: if false;
    }
    
    // ========================================
    // 5. GEO-LEGAL RULES
    // ========================================
    match /geoLegalRules/{countryCode} {
      // Anyone can read geo-legal rules
      allow read: if true;
      
      // Only admins can manage geo-legal rules
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // 6. REGULATOR AUDIT LOGS (Append-only)
    // ========================================
    match /regulatorAuditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // Only system/admin can create audit logs
      allow create: if isAdmin() &&
                       request.resource.data.keys().hasAll(['userId', 'actionType', 'createdAt']) &&
                       request.resource.data.createdAt is timestamp;
      
      // IMMUTABLE - No updates or deletes allowed
      allow update, delete: if false;
    }
  }
}
