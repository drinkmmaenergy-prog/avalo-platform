rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Payment sessions - read own, write via Cloud Functions only
    match /paymentSessions/{sessionId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only via Cloud Functions
    }
    
    // Transactions - read own, write via Cloud Functions only
    match /transactions/{txId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only via Cloud Functions
    }
    
    // User wallets - read own, write via Cloud Functions only
    match /users/{userId}/wallet/{walletId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Escrow - read if participant, write via Cloud Functions only
    match /escrow/{escrowId} {
      allow read: if isAuthenticated() && 
        (resource.data.payerId == request.auth.uid || 
         resource.data.recipientId == request.auth.uid || 
         isAdmin());
      allow write: if false; // Only via Cloud Functions
    }
    
    // Settlements - read own, write via Cloud Functions only
    match /settlements/{settlementId} {
      allow read: if isAuthenticated() && 
        (resource.data.creatorId == request.auth.uid || isAdmin());
      allow write: if false; // Only via Cloud Functions
    }
    
    // Subscriptions - read own, write via Cloud Functions only
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only via Cloud Functions
    }
    
    // Calendar bookings - read if participant
    match /calendarBookings/{bookingId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         resource.data.creatorId == request.auth.uid || 
         isAdmin());
      allow write: if false; // Only via Cloud Functions
    }
    
    // PACK 68: Support tickets - read own, write via Cloud Functions
    match /support_tickets/{ticketId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only via Cloud Functions
    }
    
    // PACK 68: Support ticket messages - read if ticket owner, write via Cloud Functions
    match /support_ticket_messages/{messageId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        exists(/databases/$(database)/documents/support_tickets/$(resource.data.ticketId)) &&
        get(/databases/$(database)/documents/support_tickets/$(resource.data.ticketId)).data.userId == request.auth.uid
      );
      allow write: if false; // Only via Cloud Functions
    }
    
    // PACK 68 & 98: Help articles - public read
    match /help_articles/{articleId} {
      allow read: if true; // Public articles
      allow write: if false; // Only via Cloud Functions
    }
    
    // PACK 98: Help categories - public read
    match /help_categories/{categoryId} {
      allow read: if true; // Public categories
      allow write: if false; // Only via Cloud Functions
    }
    
    // PACK 98: User tips state - users can read/write their own
    match /user_tips_state/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId) &&
        request.resource.data.keys().hasOnly(['userId', 'dismissedTips', 'updatedAt']) &&
        request.resource.data.userId == userId;
    }
    
    // PACK 98: User onboarding state - users can read/write their own
    match /user_onboarding_state/{userId} {
      allow read: if isOwner(userId);
      allow write: if false; // Only via Cloud Functions
    }
    
    // PACK 183: Scalability Engine collections
    match /load_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    match /scaling_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    match /scaling_config/{region} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    match /traffic_alerts/{alertId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    match /shard_assignments/{assignmentId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    match /shard_loads/{loadId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    match /latency_predictions/{predictionId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    match /client_latency_reports/{reportId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only via Cloud Functions
    }
  }
}
