rules_version = '2';

/**
 * PACK 358 â€” Financial Data Security Rules
 * 
 * CRITICAL: Finance data is HIGHLY SENSITIVE
 * - Only admin users can read
 * - Only cloud functions can write
 * - No mobile user access ever
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================

    // Check if user is authenticated admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }

    // Check if user is CEO (highest level access)
    function isCEO() {
      return request.auth != null && 
             (request.auth.token.role == 'CEO' || 
              request.auth.token.role == 'OWNER');
    }

    // Check if user has finance read permissions
    function hasFinanceReadAccess() {
      return isAdmin() || isCEO();
    }

    // ========================================================================
    // FINANCE COLLECTION - ROOT LEVEL
    // ========================================================================

    match /finance/{document} {
      // Read: Admin and CEO only
      allow read: if hasFinanceReadAccess();
      
      // Write: Functions only (requests without auth)
      allow write: if false; // Explicitly deny all writes from clients

      // ======================================================================
      // SUB-COLLECTION: Forecasts
      // ======================================================================

      match /forecasts/{forecastDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;

        match /{timeframe}/{doc} {
          allow read: if hasFinanceReadAccess();
          allow write: if false;
        }
      }

      // ======================================================================
      // SUB-COLLECTION: Burn Rate
      // ======================================================================

      match /burnrate/monthly/{monthDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      // ======================================================================
      // SUB-COLLECTION: LTV Profiles
      // ======================================================================

      match /ltv/segments/{segmentDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      match /ltv/trends/{trendDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      match /ltv/cohorts/{cohortDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      // ======================================================================
      // SUB-COLLECTION: Stress Scenarios
      // ======================================================================

      match /scenarios/results/{resultDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      match /scenarios/history/{historyDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      // ======================================================================
      // SUB-COLLECTION: Alerts
      // ======================================================================

      match /alerts/active/{alertDoc} {
        allow read: if hasFinanceReadAccess();
        
        // Allow admins to mark alerts as resolved
        allow update: if hasFinanceReadAccess() && 
                         request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['resolved', 'resolvedAt', 'resolvedBy', 'updatedAt']);
        
        allow create, delete: if false;
      }

      // ======================================================================
      // SUB-COLLECTION: Infrastructure Billing
      // ======================================================================

      match /infrastructure/billing/{monthDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      // ======================================================================
      // SUB-COLLECTION: Cash Position
      // ======================================================================

      match /cash/{doc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }
    }

    // ========================================================================
    // ANALYTICS COLLECTIONS (Read-only for finance engines)
    // ========================================================================

    match /analytics/{document} {
      // Finance engines need read access to analytics
      // But mobile clients shouldn't access raw analytics
      allow read: if hasFinanceReadAccess();
      allow write: if false;

      match /daily/revenue/{dateDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      match /monthly/revenue/{monthDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      match /users/monthly/{monthDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      match /current/{collection}/{doc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }
    }

    // ========================================================================
    // MARKETING COLLECTION (Read-only for burn rate calculations)
    // ========================================================================

    match /marketing/{document} {
      allow read: if hasFinanceReadAccess();
      allow write: if false;

      match /campaigns/monthly/{monthDoc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }

      match /metrics/{doc} {
        allow read: if hasFinanceReadAccess();
        allow write: if false;
      }
    }

    // ========================================================================
    // SUPPORT COLLECTION (Read-only for burn rate calculations)
    // ========================================================================

    match /support/metrics/monthly/{monthDoc} {
      allow read: if hasFinanceReadAccess();
      allow write: if false;
    }

    // ========================================================================
    // MODERATION COLLECTION (Read-only for burn rate calculations)
    // ========================================================================

    match /moderation/actions/monthly/{monthDoc} {
      allow read: if hasFinanceReadAccess();
      allow write: if false;
    }

    // ========================================================================
    // USER SEGMENTS (Read-only for LTV calculations)
    // ========================================================================

    match /userSegments/{userId} {
      // Users can read their own segment
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Admins can read all segments
      allow read: if hasFinanceReadAccess();
      
      allow write: if false;
    }

    // ========================================================================
    // TRANSACTIONS (Read-only for LTV calculations)
    // ========================================================================

    match /transactions/{transactionId} {
      // Users can read their own transactions
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      
      // Finance engines need read access
      allow read: if hasFinanceReadAccess();
      
      allow write: if false;
    }
  }
}
