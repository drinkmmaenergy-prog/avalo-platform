rules_version = '2';

// PACK 223: Destiny Weeks - Weekly Chemistry Event System
// Security rules for Destiny Weeks collections

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
    }
    
    // ========================================================================
    // DESTINY WEEKLY THEMES
    // ========================================================================
    // Public read, admin write
    match /destiny_weekly_themes/{themeId} {
      allow read: if true; // Anyone can see active themes
      allow write: if isAdmin(); // Only admins can create/modify themes
    }
    
    // ========================================================================
    // USER DESTINY STATES
    // ========================================================================
    // Users can read their own state, system can write
    match /destiny_user_states/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || 
                      request.auth.uid == null; // Allow backend service writes
      allow delete: if false; // Never delete, only archive
    }
    
    // ========================================================================
    // DESTINY MILESTONES
    // ========================================================================
    // Users can read their own milestones, system creates them
    match /destiny_milestones/{milestoneId} {
      allow read: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
      allow create: if request.auth.uid == null; // Backend only
      allow update: if isOwner(resource.data.userId) && 
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['claimed', 'claimedAt']); // Users can only claim
      allow delete: if false;
    }
    
    // ========================================================================
    // DESTINY REWARDS
    // ========================================================================
    // Users can read their own rewards
    match /destiny_rewards/{rewardId} {
      allow read: if isAuthenticated() && 
                    resource.data.earnedFrom.userId == request.auth.uid;
      allow write: if request.auth.uid == null; // Backend only
    }
    
    // ========================================================================
    // DESTINY LEADERBOARDS
    // ========================================================================
    // Public read for active week, no direct writes (backend manages)
    match /destiny_leaderboards/{weekId} {
      allow read: if true; // Public leaderboards
      allow write: if request.auth.uid == null; // Backend only
    }
    
    // ========================================================================
    // DESTINY WEEK RECAPS
    // ========================================================================
    // Users can read their own recaps
    match /destiny_week_recaps/{recapId} {
      allow read: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
      allow write: if request.auth.uid == null; // Backend only
    }
    
    // ========================================================================
    // DESTINY ACTIONS LOG (for analytics)
    // ========================================================================
    // Write-only for users, read for admin/analytics
    match /destiny_actions/{actionId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}