rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // PACK 379 â€” ASO, Reviews, Reputation & Store Defense
    // ========================================
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isModerator() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }
    
    function isTrustTeam() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator', 'trust_team'];
    }
    
    // ========================================
    // 1. STORE REVIEW SECURITY
    // ========================================
    match /storeReviewSecurity/{reviewId} {
      // Only system and trust team can write
      allow read: if isTrustTeam();
      allow write: if false; // System only via Cloud Functions
      
      match /history/{historyId} {
        allow read: if isTrustTeam();
        allow write: if false; // System only
      }
    }
    
    // Review attack alerts
    match /reviewAttackAlerts/{alertId} {
      allow read: if isTrustTeam();
      allow create: if false; // System only
      allow update: if isTrustTeam(); // Can mark as resolved
      allow delete: if isAdmin();
    }
    
    // Review dispute bundles
    match /reviewDisputeBundles/{bundleId} {
      allow read: if isTrustTeam();
      allow write: if false; // System only
    }
    
    // ========================================
    // 2. ASO METRICS
    // ========================================
    match /asoMetrics/{metricId} {
      allow read: if isAdmin();
      allow write: if false; // System only via Cloud Functions
      
      match /keywords/{keywordId} {
        allow read: if isAdmin();
        allow write: if false; // System only
      }
      
      match /rankings/{rankingId} {
        allow read: if isAdmin();
        allow write: if false; // System only
      }
    }
    
    // ASO experiments and A/B tests
    match /asoExperiments/{experimentId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ASO optimization suggestions
    match /asoOptimizations/{optimizationId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    // ========================================
    // 3. USER TRUST SCORES
    // ========================================
    match /userTrustScores/{userId} {
      // Users can read their own trust score (limited fields)
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || isTrustTeam());
      allow write: if false; // System only via Cloud Functions
      
      match /history/{historyId} {
        allow read: if isAuthenticated() && 
          (request.auth.uid == userId || isTrustTeam());
        allow write: if false; // System only
      }
      
      match /factors/{factorId} {
        allow read: if isTrustTeam();
        allow write: if false; // System only
      }
    }
    
    // Trust score adjustments (manual overrides)
    match /trustScoreAdjustments/{adjustmentId} {
      allow read: if isTrustTeam();
      allow create: if isTrustTeam();
      allow update: if isTrustTeam();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // 4. STORE COMPLIANCE MONITORING
    // ========================================
    match /storeComplianceAlerts/{alertId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    match /storePolicyChanges/{changeId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    match /complianceRiskScores/{riskId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    // ========================================
    // 5. CRISIS MODE & REPUTATION SHIELD
    // ========================================
    match /crisisEvents/{eventId} {
      allow read: if isTrustTeam();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
      
      match /actions/{actionId} {
        allow read: if isTrustTeam();
        allow write: if false; // System only
      }
    }
    
    match /reputationShieldStatus/{statusId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    // ========================================
    // 6. STORE-SAFE REVIEW PROMPTS
    // ========================================
    match /reviewPromptHistory/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if false; // System only
    }
    
    match /reviewPromptConfig/{configId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // 7. REPUTATION ANALYTICS
    // ========================================
    match /reputationAnalytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    match /countryReputationScores/{countryId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    match /competitorTracking/{competitorId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
      
      match /metrics/{metricId} {
        allow read: if isAdmin();
        allow write: if false; // System only
      }
    }
    
    // ========================================
    // 8. FEATURE FLAGS & CONFIG
    // ========================================
    match /pack379Config/{configId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false; // Never delete, only update
    }
    
    match /pack379FeatureFlags/{flagId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false; // Never delete, only update
    }
    
    // ========================================
    // 9. EXECUTIVE DASHBOARD
    // ========================================
    match /executiveReports/{reportId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
    
    match /reputationHealthScores/{scoreId} {
      allow read: if isAdmin();
      allow write: if false; // System only
    }
  }
}
