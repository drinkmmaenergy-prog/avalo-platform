rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isCreator() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'creator';
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate no scam claims in course description
    function hasNoScamClaims(text) {
      return !text.matches('.*(?i)(get.?rich|guaranteed.?income|earn.?\\d+.*week|no.?skills.?needed|become.?rich|overnight.?success).*');
    }
    
    // Validate safe category
    function isSafeCategory(category) {
      return category in [
        'business_fundamentals',
        'social_media_growth',
        'fitness_coaching',
        'language_teaching',
        'design_photography',
        'ecommerce',
        'productivity_mindset',
        'career_skills'
      ];
    }
    
    // Courses collection
    match /courses/{courseId} {
      allow read: if isAuthenticated() && 
                     resource.data.status == 'published';
      
      allow create: if isCreator() && 
                       request.resource.data.creatorId == request.auth.uid &&
                       request.resource.data.status == 'pending_review' &&
                       isSafeCategory(request.resource.data.category) &&
                       hasNoScamClaims(request.resource.data.title) &&
                       hasNoScamClaims(request.resource.data.description) &&
                       request.resource.data.price >= 0 &&
                       request.resource.data.price <= 50000 &&
                       !request.resource.data.keys().hasAny(['eroticContent', 'romanticAccess', 'blockedTopic']);
      
      allow update: if (isCreator() && resource.data.creatorId == request.auth.uid &&
                       request.resource.data.creatorId == resource.data.creatorId) ||
                       isAdmin();
      
      allow delete: if isAdmin() || 
                       (isCreator() && resource.data.creatorId == request.auth.uid);
      
      // Course modules subcollection
      match /modules/{moduleId} {
        allow read: if isAuthenticated() && (
          exists(/databases/$(database)/documents/course_purchases/$(request.auth.uid + '_' + courseId)) ||
          get(/databases/$(database)/documents/courses/$(courseId)).data.creatorId == request.auth.uid ||
          isAdmin()
        );
        
        allow write: if isCreator() && 
                        get(/databases/$(database)/documents/courses/$(courseId)).data.creatorId == request.auth.uid;
      }
    }
    
    // Course purchases
    match /course_purchases/{purchaseId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.creatorId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      allow update: if isAdmin();
    }
    
    // Course progress tracking
    match /course_progress/{progressId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      allow write: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid &&
                      exists(/databases/$(database)/documents/course_purchases/$(request.auth.uid + '_' + request.resource.data.courseId));
    }
    
    // Course reviews
    match /course_reviews/{reviewId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       exists(/databases/$(database)/documents/course_purchases/$(request.auth.uid + '_' + request.resource.data.courseId)) &&
                       request.resource.data.rating >= 1 &&
                       request.resource.data.rating <= 5 &&
                       hasNoScamClaims(request.resource.data.comment);
      
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Course certificates
    match /course_certificates/{certificateId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if false;
      allow update: if false;
      allow delete: if isAdmin();
    }
    
    // Education subscriptions
    match /education_subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      allow update: if isAdmin();
      
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Learning gamification progress
    match /learning_progress/{userId} {
      allow read: if isAuthenticated() && userId == request.auth.uid;
      
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // Coach Q&A sessions
    match /qa_sessions/{sessionId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.coachId == request.auth.uid ||
        isAdmin()
      );
      
      allow create: if isAuthenticated() &&
                       request.resource.data.studentId == request.auth.uid &&
                       exists(/databases/$(database)/documents/course_purchases/$(request.auth.uid + '_' + request.resource.data.courseId));
      
      allow update: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.coachId == request.auth.uid
      );
    }
    
    // Course compliance reports
    match /course_compliance_reports/{reportId} {
      allow read: if isAdmin();
      
      allow create: if isAuthenticated() &&
                       request.resource.data.reporterId == request.auth.uid;
      
      allow update: if isAdmin();
    }
  }
}