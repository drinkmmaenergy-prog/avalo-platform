rules_version = '2';

/**
 * PACK 328B â€” Chat & Session Inactivity Timeouts
 * 
 * Firestore Security Rules for chat session timeout fields.
 * 
 * New fields added to chats collection:
 * - status: ACTIVE | ENDED | EXPIRED | CANCELLED
 * - lastMessageAt: ISO timestamp
 * - lastPaidBucketAt: ISO timestamp (optional)
 * - autoExpireAt: ISO timestamp (optional)
 * - expiredAt: timestamp (optional)
 * - expiredReason: string (optional)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isParticipant(chat) {
      return isAuthenticated() && 
             request.auth.uid in chat.participants;
    }
    
    function isModerator() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.moderator == true;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
    }
    
    // ========================================================================
    // CHATS COLLECTION - Extended for PACK 328B
    // ========================================================================
    
    match /chats/{chatId} {
      // Read: Participants can read their own chats
      allow read: if isParticipant(resource.data);
      
      // Create: Participants can create chats (handled by Cloud Functions)
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      
      // Update: Participants can update certain fields
      // System can update timeout fields via Cloud Functions
      allow update: if isParticipant(resource.data) && (
        // Users can update lastMessageAt when sending messages
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['lastMessageAt', 'lastActivityAt', 'updatedAt', 'billing']) ||
        
        // Users can manually end the chat (status -> ENDED)
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['status', 'state', 'closedAt', 'closedBy', 'updatedAt']) &&
         request.resource.data.status == 'ENDED' &&
         request.resource.data.closedBy == request.auth.uid)
      );
      
      // System updates (via Cloud Functions with admin token)
      allow update: if isAdmin() || isModerator();
      
      // Delete: Only admins can delete (cleanup purposes)
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // CALLS COLLECTION - Extended for PACK 328B
    // ========================================================================
    
    match /calls/{callId} {
      function isCallParticipant(call) {
        return isAuthenticated() && 
               (request.auth.uid == call.payerId || 
                request.auth.uid == call.earnerId);
      }
      
      // Read: Participants can read their own calls
      allow read: if isCallParticipant(resource.data);
      
      // Create: Cloud Functions only
      allow create: if isAdmin();
      
      // Update: Participants can update lastActivityAt
      // System can update all fields
      allow update: if isCallParticipant(resource.data) && 
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['lastActivityAt', 'updatedAt']);
      
      // System updates
      allow update: if isAdmin();
      
      // Delete: Only admins
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // TRANSACTIONS COLLECTION - Read-only for users
    // ========================================================================
    
    match /transactions/{txId} {
      // Users can read their own transactions
      allow read: if isOwner(resource.data.userId);
      
      // Only system can create/update transactions
      allow create, update: if isAdmin();
      
      // No deletion of transaction records
      allow delete: if false;
    }
  }
}