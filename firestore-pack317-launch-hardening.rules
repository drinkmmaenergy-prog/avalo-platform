rules_version = '2';

/**
 * PACK 317 â€” Launch Hardening, Security & Rate Limits
 * Firestore Security Rules
 * 
 * Collections:
 * - rateLimits (rate limit counters)
 * - pack317_rate_limit_violations (violation logs)
 * - pack317_registrations (registration tracking)
 * - pack317_message_tracking (spam detection)
 * - pack317_spam_detections (spam logs)
 * - pack317_security_events (security analytics)
 * - config/launch (launch configuration)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // RATE LIMITS
    // ========================================================================
    
    // Rate limit counters (system-managed, no user access)
    match /rateLimits/{rateKey} {
      allow read: if false; // Only backend can read
      allow write: if false; // Only backend can write
    }
    
    // Rate limit violations (admin read-only)
    match /pack317_rate_limit_violations/{violationId} {
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
      allow write: if false; // Only backend writes
    }
    
    // ========================================================================
    // ANTI-BOT & SPAM TRACKING
    // ========================================================================
    
    // Registration tracking (system-only)
    match /pack317_registrations/{regId} {
      allow read: if false;
      allow write: if false;
    }
    
    // Message tracking for spam detection (system-only)
    match /pack317_message_tracking/{trackId} {
      allow read: if false;
      allow write: if false;
    }
    
    // Spam detection logs (admin read-only)
    match /pack317_spam_detections/{spamId} {
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
      allow write: if false;
    }
    
    // ========================================================================
    // SECURITY ANALYTICS
    // ========================================================================
    
    // Security events (admin read-only)
    match /pack317_security_events/{eventId} {
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
      allow write: if false; // Only backend writes
    }
    
    // ========================================================================
    // LAUNCH CONFIGURATION
    // ========================================================================
    
    // Launch config (public read, admin write)
    match /config/launch {
      allow read: if true; // Public read for checking maintenance mode
      allow write: if request.auth != null && 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    // ========================================================================
    // ENFORCEMENT STATES (for limited mode)
    // ========================================================================
    
    // Enforcement states (user can read own, admin can read/write all)
    match /enforcement_states/{userId} {
      allow read: if request.auth != null && 
                     (request.auth.uid == userId || 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN');
      allow write: if false; // Only backend and admin functions can write
    }
    
    // ========================================================================
    // RISK EVENTS (for spam/abuse tracking)
    // ========================================================================
    
    // Risk events (admin read-only)
    match /risk_events/{eventId} {
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
      allow write: if false; // Only backend writes
    }
  }
}