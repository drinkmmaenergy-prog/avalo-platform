rules_version = '2';

// PACK 306 â€” Mandatory Identity Verification
// Firestore Security Rules

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
    }
    
    function isVerified() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)/verification/status).data.status == 'VERIFIED';
    }
    
    // ============================================================================
    // PACK 306 VERIFICATION STATUS
    // ============================================================================
    
    match /users/{userId}/verification/status {
      // Read: User can read their own status, admins can read any
      allow read: if isUser(userId) || isAdmin();
      
      // Create: Only backend (Cloud Functions)
      allow create: if false;
      
      // Update: Only backend (Cloud Functions) or admin override
      allow update: if false;
      
      // Delete: Never
      allow delete: if false;
    }
    
    // ============================================================================
    // VERIFICATION ATTEMPTS LOG
    // ============================================================================
    
    match /users/{userId}/verification/attempts/{attemptId} {
      // Read: User can read their own attempts, admins can read any
      allow read: if isUser(userId) || isAdmin();
      
      // Create/Update/Delete: Only backend
      allow create, update, delete: if false;
    }
    
    // ============================================================================
    // VERIFICATION REVIEW QUEUE
    // ============================================================================
    
    match /verificationReviewQueue/{reviewId} {
      // Read: Admins only
      allow read: if isAdmin();
      
      // Create: Backend only
      allow create: if false;
      
      // Update: Admins can update review status
      allow update: if isAdmin() && 
                       request.resource.data.reviewedBy == request.auth.uid &&
                       request.resource.data.reviewedAt == request.time;
      
      // Delete: Admins only
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // MEETING SELFIE VERIFICATION
    // ============================================================================
    
    match /pack306_meeting_verifications/{verificationId} {
      // Read: Meeting participants or admins
      allow read: if isAuthenticated() && 
                     (request.auth.uid in resource.data.participants ||
                      isAdmin());
      
      // Create: Meeting participants
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.timestamp == request.time;
      
      // Update/Delete: Backend only
      allow update, delete: if false;
    }
    
    // ============================================================================
    // VERIFICATION AUDIT LOGS
    // ============================================================================
    
    match /auditLogs/{logId} {
      // Read: Admins only
      allow read: if isAdmin();
      
      // Create: Backend only
      allow create: if false;
      
      // Update/Delete: Never
      allow update, delete: if false;
    }
    
    // ============================================================================
    // ACCESS CONTROL OVERRIDES
    // Block all major features until verified
    // ============================================================================
    
    // Discovery/Swipe
    match /swipes/{swipeId} {
      allow read, write: if isVerified();
    }
    
    // Feed
    match /feed/{feedId} {
      allow read, write: if isVerified();
    }
    
    // Messages (override existing rules)
    match /pack273_chats/{chatId} {
      allow read, write: if isVerified() &&
                            request.auth.uid in resource.data.participants;
    }
    
    match /pack273_chats/{chatId}/messages/{messageId} {
      allow read, write: if isVerified() &&
                            request.auth.uid in get(/databases/$(database)/documents/pack273_chats/$(chatId)).data.participants;
    }
    
    // Wallet/Earnings
    match /wallets/{userId} {
      allow read, write: if isVerified() && isUser(userId);
    }
    
    match /earnings/{earningId} {
      allow read: if isVerified() && resource.data.userId == request.auth.uid;
    }
    
    // Calendar/Events
    match /pack274_calendar_events/{eventId} {
      allow read, write: if isVerified();
    }
    
    match /pack275_events/{eventId} {
      allow read, write: if isVerified();
    }
    
    // Creator Tools
    match /creator_profiles/{userId} {
      allow read: if true; // Public read
      allow write: if isVerified() && isUser(userId);
    }
    
    // AI Companions
    match /ai_companions/{companionId} {
      allow read: if true; // Public read
      allow write: if isVerified() && 
                      resource.data.creatorId == request.auth.uid;
    }
    
    // Search/Discovery
    match /discovery_profiles/{userId} {
      allow read: if isVerified();
      allow write: if isVerified() && isUser(userId);
    }
  }
}