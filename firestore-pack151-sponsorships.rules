rules_version = '2';

/**
 * PACK 151 - Sponsorship Marketplace Firestore Rules
 * Ethical brand-creator collaboration with strict safety controls
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isModerator() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.moderator == true;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
    }
    
    function hasModeratorAccess() {
      return isModerator() || isAdmin();
    }
    
    // Sponsorship Offers
    match /sponsorship_offers/{offerId} {
      // Anyone can read active, open sponsorship offers
      allow read: if isAuthenticated() && 
                     resource.data.status == 'open' && 
                     resource.data.metadata.isActive == true;
      
      // Only brand owner can create offers for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.brandId == request.auth.uid &&
                       request.resource.data.safetyFlags.hasRomanticContent == false &&
                       request.resource.data.safetyFlags.hasNSFWContent == false;
      
      // Only brand owner can update their offers
      allow update: if isAuthenticated() && 
                       resource.data.brandId == request.auth.uid &&
                       request.resource.data.brandId == resource.data.brandId;
      
      // Only brand owner or moderator can delete
      allow delete: if (isAuthenticated() && resource.data.brandId == request.auth.uid) ||
                       hasModeratorAccess();
    }
    
    // Sponsorship Applications
    match /sponsorship_applications/{applicationId} {
      // Creator can read their own applications
      // Brand can read applications for their offers
      allow read: if isAuthenticated() && 
                     (resource.data.creatorId == request.auth.uid ||
                      resource.data.brandId == request.auth.uid);
      
      // Only creators can apply to sponsorships
      allow create: if isAuthenticated() && 
                       request.resource.data.creatorId == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      // Only brand can update application status
      allow update: if isAuthenticated() && 
                       resource.data.brandId == request.auth.uid &&
                       resource.data.creatorId == request.resource.data.creatorId;
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Sponsorship Contracts
    match /sponsorship_contracts/{contractId} {
      // Only contract parties can read
      allow read: if isAuthenticated() && 
                     (resource.data.brandId == request.auth.uid ||
                      resource.data.creatorId == request.auth.uid);
      
      // Only system (via Cloud Functions) can create contracts
      allow create: if false;
      
      // Brand or creator can update their contract
      allow update: if isAuthenticated() && 
                       (resource.data.brandId == request.auth.uid ||
                        resource.data.creatorId == request.auth.uid) &&
                       resource.data.brandId == request.resource.data.brandId &&
                       resource.data.creatorId == request.resource.data.creatorId;
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Sponsorship Deliverables
    match /sponsorship_deliverables/{deliverableId} {
      // Only contract parties can read
      allow read: if isAuthenticated() && 
                     (resource.data.brandId == request.auth.uid ||
                      resource.data.creatorId == request.auth.uid);
      
      // Only creator can create deliverables for their contracts
      allow create: if isAuthenticated() && 
                       request.resource.data.creatorId == request.auth.uid &&
                       request.resource.data.safetyCheck.passed == true &&
                       request.resource.data.safetyCheck.hasRomanticContent == false &&
                       request.resource.data.safetyCheck.hasNSFWContent == false &&
                       request.resource.data.safetyCheck.hasSeductivePosing == false &&
                       request.resource.data.safetyCheck.hasExternalLinks == false;
      
      // Creator can update deliverables before submission
      // Brand can update to approve/reject
      allow update: if isAuthenticated() && 
                       ((resource.data.creatorId == request.auth.uid && 
                         resource.data.status == 'pending') ||
                        (resource.data.brandId == request.auth.uid && 
                         resource.data.status == 'submitted'));
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Sponsorship Reviews
    match /sponsorship_reviews/{reviewId} {
      // Reviews are public by default
      allow read: if isAuthenticated();
      
      // Only contract parties can create reviews after completion
      allow create: if isAuthenticated() && 
                       (request.resource.data.reviewerId == request.auth.uid) &&
                       (request.resource.data.reviewerType == 'brand' || 
                        request.resource.data.reviewerType == 'creator') &&
                       request.resource.data.rating >= 1 && 
                       request.resource.data.rating <= 5;
      
      // No updates allowed
      allow update: if false;
      
      // Only review author or moderator can delete
      allow delete: if (isAuthenticated() && 
                        resource.data.reviewerId == request.auth.uid) ||
                       hasModeratorAccess();
    }
    
    // Token Escrow (for sponsorships)
    match /token_escrow/{escrowId} {
      // Only contract parties can read their escrow
      allow read: if isAuthenticated() && 
                     (resource.data.brandId == request.auth.uid ||
                      resource.data.creatorId == request.auth.uid);
      
      // Only system can create/update escrow
      allow create: if false;
      allow update: if false;
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Sponsorship Moderations
    match /sponsorship_moderations/{moderationId} {
      // Only moderators can read moderation records
      allow read: if hasModeratorAccess();
      
      // Only moderators can create moderation records
      allow create: if hasModeratorAccess() && 
                       request.resource.data.moderatorId == request.auth.uid;
      
      // Only original moderator can update
      allow update: if hasModeratorAccess() && 
                       resource.data.moderatorId == request.auth.uid;
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Sponsorship Analytics (aggregate data only)
    match /sponsorship_analytics/{analyticsId} {
      // Only contract parties can read analytics
      allow read: if isAuthenticated() && 
                     (resource.data.brandId == request.auth.uid ||
                      resource.data.creatorId == request.auth.uid);
      
      // Only system can write analytics
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // Additional safety: Block direct writes to user sponsorship stats
    match /users/{userId}/sponsorship/{document=**} {
      allow read: if isAuthenticated() && 
                     (userId == request.auth.uid || hasModeratorAccess());
      
      // Only system can update sponsorship stats
      allow write: if false;
    }
  }
}