rules_version = '2';

/**
 * PACK 411 â€” App Store Defense, Reviews, Reputation & Trust Engine
 * Firestore Security Rules
 * 
 * Collections:
 * - storeReviews
 * - storeReputationSnapshots
 * - ratingPromptLogs
 * - reviewBrigadeAlerts
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPER_ADMIN';
    }
    
    function isModerator() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'SUPER_ADMIN', 'MODERATOR'];
    }

    // Store Reviews - Admin/Moderator read-only, backend writes only
    match /storeReviews/{reviewId} {
      allow read: if isModerator();
      allow write: if false; // Only Cloud Functions can write
    }

    // Reputation Snapshots - Admins and dashboard views
    match /storeReputationSnapshots/{snapshotId} {
      allow read: if isModerator(); // Moderators can view aggregated stats
      allow write: if false; // Only Cloud Functions can write
    }

    // Rating Prompt Logs - User can read their own, admins read all
    match /ratingPromptLogs/{logId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isModerator());
      allow write: if false; // Only Cloud Functions can write
    }

    // Review Brigade Alerts - Admin only
    match /reviewBrigadeAlerts/{alertId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin(); // Only super admins can update alert status
    }

    // In-App Rating Config - Admin read/write
    match /config/pack411InAppRating {
      allow read: if isAuthenticated(); // Users need to check if prompts are enabled
      allow write: if isAdmin();
    }

    // Reputation Defense Config - Admin only
    match /config/pack411ReputationDefense {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    // Public aggregated stats (for dashboards, investor views)
    match /public/pack411ReputationStats {
      allow read: if true; // Public read for aggregated, anonymized stats
      allow write: if false; // Only Cloud Functions
    }
  }
}
