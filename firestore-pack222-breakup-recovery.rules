rules_version = '2';

// PACK 222: Breakup Recovery & Chemistry Restart Engine - Firestore Security Rules
// Emotional safety design, confidence rebuilding, and non-aggressive chemistry restart

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isSafetyTeam() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.safety_team == true;
    }
    
    // =================================================================
    // BREAKUP RECOVERY STATES COLLECTION
    // User's recovery state after journey ending
    // =================================================================
    match /breakup_recovery_states/{recoveryId} {
      // Read: Only the user themselves or admins
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Create: Only backend (Cloud Functions)
      allow create: if false;
      
      // Update: User can only update specific fields (safety confirmation)
      // Backend can update all fields
      allow update: if isOwner(resource.data.userId) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['safetyCleared', 'updatedAt']);
      
      // Delete: Only admins
      allow delete: if isAdmin();
    }
    
    // =================================================================
    // CONFIDENCE BOOST CARDS COLLECTION
    // Real social signals shown during rebuild phase
    // =================================================================
    match /confidence_boost_cards/{cardId} {
      // Read: Only the user themselves
      allow read: if isOwner(resource.data.userId);
      
      // Create: Only backend (generates based on real data)
      allow create: if false;
      
      // Update: User can mark as shown or dismissed
      allow update: if isOwner(resource.data.userId) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['shownAt', 'dismissedAt']);
      
      // Delete: Only backend or admins
      allow delete: if isAdmin();
    }
    
    // =================================================================
    // CHEMISTRY RESTART SUGGESTIONS COLLECTION
    // Non-aggressive chemistry restart matches
    // =================================================================
    match /chemistry_restart_suggestions/{suggestionId} {
      // Read: Only the user receiving the suggestion
      allow read: if isOwner(resource.data.userId);
      
      // Create: Only backend (chemistry algorithm)
      allow create: if false;
      
      // Update: User can track interactions
      allow update: if isOwner(resource.data.userId) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['shownAt', 'interactedAt', 'interaction']);
      
      // Delete: Only backend or admins
      allow delete: if isAdmin();
    }
    
    // =================================================================
    // INTEGRATION WITH EXISTING COLLECTIONS
    // =================================================================
    
    // Romantic Journeys - extended with recovery hook
    match /romantic_journeys/{journeyId} {
      // Existing rules from PACK 221 apply
      // Recovery state is created when journey ends
      allow read: if isAuthenticated() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid ||
        isAdmin()
      );
    }
  }
}

// =================================================================
// INTEGRATION NOTES
// =================================================================
// - Recovery states are created automatically when journeys end (PACK 221)
// - Safety integration with PACK 210/211 for pause/resume
// - Confidence cards use real data from wishlists, visits, badges
// - Chemistry suggestions integrate with existing matching algorithm
// - NO payment modifications - emotional retention only