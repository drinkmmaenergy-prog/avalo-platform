// ============================================================================
// PACK 95 â€” Account, Device & Session Security
// Firestore Security Rules
// ============================================================================

// Collection: user_devices
// Users can read & write only documents where userId == request.auth.uid
match /user_devices/{deviceId} {
  // Allow read if user owns this device
  allow read: if request.auth != null && 
                 resource.data.userId == request.auth.uid;
  
  // Allow create/update if:
  // 1. User is authenticated
  // 2. userId matches authenticated user
  // 3. deviceId cannot be changed
  allow create: if request.auth != null &&
                   request.resource.data.userId == request.auth.uid &&
                   request.resource.data.id == deviceId;
  
  allow update: if request.auth != null &&
                   resource.data.userId == request.auth.uid &&
                   request.resource.data.userId == request.auth.uid &&
                   request.resource.data.id == deviceId;
  
  // Prevent deletion by clients (managed by backend)
  allow delete: if false;
}

// Collection: user_sessions
// Users can read only sessions where userId == request.auth.uid
// Users CANNOT directly write to sessions (must go through Cloud Functions)
match /user_sessions/{sessionId} {
  // Allow read if user owns this session
  allow read: if request.auth != null && 
                 resource.data.userId == request.auth.uid;
  
  // Prevent direct writes (must use Cloud Functions)
  allow create: if false;
  allow update: if false;
  allow delete: if false;
}

// Collection: login_anomalies
// NOT readable by normal users
// Only accessible via Cloud Functions for security/admin/trust tooling
match /login_anomalies/{anomalyId} {
  // No direct client access
  allow read: if false;
  allow write: if false;
}