/**
 * PACK 84 â€” KYC Storage Security Rules
 * Firebase Storage rules for KYC document images
 * 
 * CRITICAL SECURITY REQUIREMENTS:
 * - KYC images are highly sensitive personal data
 * - Only owner and admins can access images
 * - Public read is STRICTLY FORBIDDEN
 * - Proper path structure enforcement
 */

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ========================================================================
    // KYC IMAGES - MAXIMUM SECURITY
    // ========================================================================
    
    // Path structure: kyc_images/{userId}/{documentType}_{timestamp}.{ext}
    match /kyc_images/{userId}/{imageFile} {
      
      // Read access: Only the owner can read their own KYC images
      // Admin access should be handled server-side, not in storage rules
      allow read: if request.auth != null && 
                     request.auth.uid == userId;
      
      // Write access: Only the owner can upload their own KYC images
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      // Validate file is an image
                      request.resource.contentType.matches('image/.*') &&
                      // Limit file size to 10MB
                      request.resource.size < 10 * 1024 * 1024 &&
                      // Validate filename format
                      imageFile.matches('^(front|back|selfie)_\\d+\\.(jpg|jpeg|png|webp)$');
      
      // Deletion: Users can delete their own images
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }
    
    // Deny all other storage access by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}