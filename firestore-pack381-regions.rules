rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'];
    }
    
    function isModerator() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin', 'moderator'];
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Region Configurations
    // Only admins can write, authenticated users can read enabled regions
    match /regionConfigs/{regionId} {
      allow read: if isAuthenticated() && resource.data.enabled == true;
      allow read: if isAdmin(); // Admins can read all including disabled
      allow write: if isAdmin();
    }
    
    // Regional Price Policies
    // Only admins can write, authenticated users can read for their region
    match /regionalPricePolicies/{regionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Regional Risk Profiles
    // Only admins can write, moderators can read
    match /regionalRiskProfiles/{regionId} {
      allow read: if isModerator();
      allow write: if isAdmin();
    }
    
    // User Risk Scores
    // Users can read their own, admins/moderators can read all
    match /userRiskScores/{userId} {
      allow read: if isOwner(userId) || isModerator();
      allow write: if false; // Only callable functions can write
    }
    
    // Regional Content Rules
    // Only admins can write, authenticated users can read for their region
    match /regionalContentRules/{regionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Moderation Queue
    // Only moderators and admins can access
    match /moderationQueue/{queueId} {
      allow read: if isModerator();
      allow write: if isModerator();
    }
    
    // Moderation Logs
    // Users can read their own logs, moderators can read all
    match /moderationLogs/{logId} {
      allow read: if isOwner(resource.data.userId) || isModerator();
      allow write: if false; // Only callable functions can write
    }
    
    // Moderation Reviews
    // Only moderators can access
    match /moderationReviews/{reviewId} {
      allow read: if isModerator();
      allow write: if isModerator();
    }
    
    // Moderation Appeals
    // Users can read/create their own appeals, moderators can read/update all
    match /moderationAppeals/{appealId} {
      allow read: if isOwner(resource.data.userId) || isModerator();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isModerator();
    }
    
    // Regional Incidents
    // Only moderators and admins can access
    match /regionalIncidents/{incidentId} {
      allow read: if isModerator();
      allow write: if isModerator();
    }
    
    // Region Expansion Status
    // Admins can write, authenticated users can read
    match /regionExpansionStatus/{regionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Expansion Readiness Scores
    // Admins can read/write, public can read basic info
    match /expansionReadinessScores/{regionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Audit Logs (from PACK 296)
    // Referenced by regional risk system
    match /auditLogs/{logId} {
      allow read: if isOwner(resource.data.userId) || isModerator();
      allow write: if false; // Only callable functions can write
    }
    
    // User Retention (from PACK 301)
    // Referenced by regional risk system
    match /userRetention/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false; // Only callable functions can write
    }
    
    // Fraud Detection (from PACK 302)
    // Referenced by regional risk system
    match /fraudDetection/{userId} {
      allow read: if isModerator();
      allow write: if false; // Only callable functions can write
    }
  }
}
