rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isVerifiedCreator() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/creatorVerification/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/creatorVerification/$(request.auth.uid)).data.status == 'approved';
    }
    
    // Creator Verification - KYC/KYB
    match /creatorVerification/{userId} {
      allow read: if isUser(userId) || isAdmin();
      allow create: if isUser(userId) && 
                      request.resource.data.keys().hasAll([
                        'userId', 'createdAt', 'status', 'level', 'governmentIdUploaded'
                      ]);
      allow update: if (isUser(userId) && resource.data.status == 'pending') || isAdmin();
      allow delete: if false;
    }
    
    // Creator Tax Status
    match /creatorTaxStatus/{userId} {
      allow read: if isUser(userId) || isAdmin();
      allow write: if isUser(userId) && 
                     request.resource.data.keys().hasAll([
                       'userId', 'taxResidency', 'updatedAt'
                     ]);
      allow delete: if false;
    }
    
    // Creator KYB (Business verification)
    match /creatorKYB/{userId} {
      allow read: if isUser(userId) || isAdmin();
      allow create: if isUser(userId) && 
                      request.resource.data.keys().hasAll([
                        'userId', 'companyName', 'companyRegistration', 'createdAt'
                      ]);
      allow update: if (isUser(userId) && resource.data.status == 'pending') || isAdmin();
      allow delete: if false;
    }
    
    // Creator Compliance Flags
    match /creatorComplianceFlags/{flagId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // VAT Rates Cache
    match /vatRates/{countryCode} {
      allow read: if true; // Public read for tax calculations
      allow write: if isAdmin();
    }
    
    // Purchase Invoices
    match /purchaseInvoices/{invoiceId} {
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if false; // Created by Cloud Functions only
      allow update: if false;
      allow delete: if false;
    }
    
    // Creator Payout Statements
    match /creatorPayoutStatements/{statementId} {
      allow read: if isAuthenticated() && 
                    (resource.data.creatorId == request.auth.uid || isAdmin());
      allow create: if false; // Created by Cloud Functions only
      allow update: if false;
      allow delete: if false;
    }
    
    // Creator Tax Statements
    match /creatorTaxStatements/{statementId} {
      allow read: if isAuthenticated() && 
                    (resource.data.creatorId == request.auth.uid || isAdmin());
      allow create: if false; // Created by Cloud Functions only
      allow update: if false;
      allow delete: if false;
    }
    
    // Payout Tax Logs
    match /payoutTaxLogs/{logId} {
      allow read: if isAuthenticated() && 
                    (resource.data.creatorId == request.auth.uid || isAdmin());
      allow create: if false; // Created by Cloud Functions only
      allow update: if false;
      allow delete: if false;
    }
    
    // Transaction VAT Records
    match /transactionVAT/{transactionId} {
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if false; // Created by Cloud Functions only
      allow update: if false;
      allow delete: if false;
    }
    
    // Payout Requests
    match /payoutRequests/{requestId} {
      allow read: if isAuthenticated() && 
                    (resource.data.creatorId == request.auth.uid || isAdmin());
      allow create: if isVerifiedCreator() && 
                      request.resource.data.creatorId == request.auth.uid &&
                      request.resource.data.status == 'pending';
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // Payment Method Validation
    match /paymentMethods/{methodId} {
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isUser(resource.data.userId);
      allow update: if isUser(resource.data.userId) || isAdmin();
      allow delete: if isUser(resource.data.userId);
    }
    
    // Sanctions List Check Results
    match /sanctionsChecks/{userId} {
      allow read: if isAdmin();
      allow write: if false; // Created by Cloud Functions only
    }
    
    // Compliance Audit Trail
    match /complianceAuditTrail/{auditId} {
      allow read: if isAdmin();
      allow create: if false; // Created by Cloud Functions only
      allow update: if false;
      allow delete: if false;
    }
    
    // Chargeback Records
    match /chargebacks/{chargebackId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Fraud Detection Flags (PACK 302 integration)
    match /fraudFlags/{flagId} {
      allow read: if isAdmin();
      allow write: if false; // Created by Cloud Functions only
    }
  }
}
