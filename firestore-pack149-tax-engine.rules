rules_version = '2';

/**
 * PACK 149: Global Tax Engine & Compliance Hub
 * Firestore Security Rules
 * 
 * Privacy-first tax compliance:
 * - Users can only access their own tax data
 * - No visibility into other users' tax information
 * - Admin/moderator access for verification only
 * - Strict read/write permissions
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.admin == true;
    }
    
    function isModerator() {
      return isAuthenticated() && 
             (request.auth.token.admin == true || 
              request.auth.token.moderator == true);
    }
    
    // Tax Profiles Collection
    // Users can only read/write their own tax profile
    match /tax_profiles/{profileId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      isAdmin() || 
                      isModerator());
      
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.profileCompleted == true &&
                       request.resource.data.fraudSuspected == false &&
                       request.resource.data.locked == false;
      
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       resource.data.locked == false &&
                       // Users cannot modify these sensitive fields
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.fraudSuspected == resource.data.fraudSuspected &&
                       request.resource.data.locked == resource.data.locked;
      
      // Only admins can delete tax profiles
      allow delete: if isAdmin();
    }
    
    // Tax Liability Records Collection
    // Read-only for users, system-generated
    match /tax_liability_records/{recordId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      isAdmin());
      
      // Only system can create/update liability records
      allow create, update, delete: if false;
    }
    
    // Tax Reports Collection
    // Users can only access their own reports
    match /tax_reports/{reportId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      isAdmin());
      
      // Only system can create tax reports
      allow create, update: if false;
      
      // Users can delete their own expired reports
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.time > resource.data.expiresAt;
    }
    
    // Tax Export Logs Collection
    // Admin-only access for audit trail
    match /tax_export_logs/{logId} {
      allow read: if isAdmin();
      
      // Only system can create export logs
      allow create, update, delete: if false;
    }
    
    // Tax Audit Trail Collection
    // User can read their own audit entries, admins can read all
    match /tax_audit_trail/{entryId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      isAdmin());
      
      // Only system can create audit entries
      allow create, update, delete: if false;
    }
    
    // Prevent access to any other tax-related collections
    match /tax_{collection}/{document=**} {
      allow read, write: if false;
    }
  }
}