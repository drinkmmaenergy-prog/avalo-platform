rules_version = '2';

// PACK 234: Anniversary System - Firestore Security Rules
// Automatic celebrations that reactivate couples emotionally

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isParticipant(participantIds) {
      return isAuthenticated() && request.auth.uid in participantIds;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ========================================================================
    // ANNIVERSARY STATUS
    // Core anniversary tracking per couple
    // ========================================================================
    match /anniversary_status/{coupleId} {
      // Read: Participants or admins
      allow read: if isParticipant(resource.data.participantIds) || isAdmin();
      
      // Create: Only backend creates initial status
      allow create: if false;
      
      // Update: Only backend updates tracking data
      allow update: if false;
      
      // Delete: Never delete, only deactivate
      allow delete: if false;
    }
    
    // ========================================================================
    // ANNIVERSARY CELEBRATIONS
    // Active and historical celebrations
    // ========================================================================
    match /anniversary_celebrations/{celebrationId} {
      // Read: Participants can view their celebrations
      allow read: if isParticipant(resource.data.participantIds) || isAdmin();
      
      // Create: Only backend creates celebrations
      allow create: if false;
      
      // Update: Participants can acknowledge viewing celebration
      allow update: if isParticipant(resource.data.participantIds) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['viewedBy', 'viewedAt', 'lastInteractionAt']);
      
      // Delete: Never delete celebrations (historical data)
      allow delete: if false;
    }
    
    // ========================================================================
    // ANNIVERSARY STREAKS
    // Streak point tracking per couple
    // ========================================================================
    match /anniversary_streaks/{coupleId} {
      // Read: Participants can view their streak
      allow read: if isParticipant(resource.data.participantIds) || isAdmin();
      
      // Create: Only backend creates streaks
      allow create: if false;
      
      // Update: Only backend updates streak points
      allow update: if false;
      
      // Delete: Only backend cleanup
      allow delete: if false;
    }
    
    // ========================================================================
    // ANNIVERSARY STREAK ACTIVITIES
    // Individual activities that contribute to streaks
    // ========================================================================
    match /anniversary_streak_activities/{activityId} {
      // Read: Participants can view activities
      allow read: if isParticipant(resource.data.participantIds) || isAdmin();
      
      // Create: Only backend tracks activities
      allow create: if false;
      
      // Update: Only backend
      allow update: if false;
      
      // Delete: Only backend cleanup
      allow delete: if false;
    }
    
    // ========================================================================
    // ANNIVERSARY REWARDS
    // Unlocked cosmetic rewards from streaks
    // ========================================================================
    match /anniversary_rewards/{rewardId} {
      // Read: Participants can view their rewards
      allow read: if isParticipant(resource.data.participantIds) || isAdmin();
      
      // Create: Only backend creates rewards
      allow create: if false;
      
      // Update: Participants can activate rewards they've earned
      allow update: if isParticipant(resource.data.participantIds) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['isActive', 'activatedAt']) &&
        resource.data.isEarned == true &&
        (!resource.data.keys().hasAny(['expiresAt']) || 
         resource.data.expiresAt > request.time);
      
      // Delete: Never delete earned rewards
      allow delete: if false;
    }
    
    // ========================================================================
    // ANNIVERSARY ANALYTICS
    // Platform-wide anniversary statistics
    // ========================================================================
    match /anniversary_analytics/{analyticsId} {
      // Read: Only admins
      allow read: if isAdmin();
      
      // Write: Only backend
      allow write: if false;
    }
    
    // ========================================================================
    // ANNIVERSARY SETTINGS
    // User preferences for anniversary features
    // ========================================================================
    match /users/{userId}/settings/anniversary {
      // Read: Own settings only
      allow read: if isOwner(userId);
      
      // Create/Update: User can manage their own settings
      allow create, update: if isOwner(userId) &&
        (!request.resource.data.keys().hasAny(['enabled']) ||
         request.resource.data.enabled is bool);
      
      // Delete: Can disable by deletion
      allow delete: if isOwner(userId);
    }
    
    // ========================================================================
    // ANNIVERSARY MILESTONE HISTORY
    // Historical record of all milestone events
    // ========================================================================
    match /anniversary_milestone_history/{historyId} {
      // Read: Participants can read their history
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participantIds;
      
      // Write: Only backend
      allow write: if false;
    }
    
    // ========================================================================
    // ANNIVERSARY NOTIFICATIONS
    // Generated notifications for celebrations
    // ========================================================================
    match /anniversary_notifications/{notificationId} {
      // Read: Recipient can read their notifications
      allow read: if isOwner(resource.data.recipientUserId);
      
      // Create: Only backend creates notifications
      allow create: if false;
      
      // Update: User can mark as read
      allow update: if isOwner(resource.data.recipientUserId) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['isRead', 'readAt']);
      
      // Delete: User can delete their notifications
      allow delete: if isOwner(resource.data.recipientUserId);
    }
  }
}

// =================================================================
// INTEGRATION NOTES
// =================================================================
// - Pauses when Sleep Mode active (PACK 228)
// - Pauses when Breakup Recovery active (PACK 222)
// - Respects safety incidents between couples
// - Uses Memory Log for first memory anniversaries (PACK 229)
// - Does NOT modify chat/call pricing or tokenomics
// - Does NOT provide free tokens or discounts
// - Rewards are cosmetic only (themes, stickers, badges, frames)
// - Streak activities tracked from paid interactions only
// - All celebration data is preserved (never deleted)
// - User can disable system individually in settings
// =================================================================