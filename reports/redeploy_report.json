{
  "timestamp": "2025-11-05T21:56:11Z",
  "project": "avalo-c8c46",
  "region": "europe-west3",
  "status": "PARTIAL_SUCCESS",
  "summary": {
    "environmentVariables": "COMPLETED",
    "firebaseFunctionsConfig": "COMPLETED",
    "codeFixes": "COMPLETED",
    "localBuild": "COMPLETED",
    "oldFunctionsCleanup": "COMPLETED",
    "deployment": "BLOCKED",
    "endpointVerification": "PENDING",
    "integrationTests": "PENDING"
  },
  "completedActions": [
    {
      "step": 1,
      "action": "Verify environment variables",
      "status": "SUCCESS",
      "details": "All required environment variables present in functions/.env",
      "variables": [
        "STRIPE_SECRET_KEY",
        "STRIPE_WEBHOOK_SECRET",
        "OPENAI_API_KEY",
        "ANTHROPIC_API_KEY"
      ]
    },
    {
      "step": 2,
      "action": "Configure Firebase Functions",
      "status": "SUCCESS",
      "command": "firebase functions:config:set",
      "note": "Legacy API deprecated, migrate to dotenv before March 2026"
    },
    {
      "step": 3,
      "action": "Fix Stripe initialization",
      "status": "SUCCESS",
      "file": "functions/src/payments.ts",
      "change": "Converted from eager to lazy initialization"
    },
    {
      "step": 4,
      "action": "Local build",
      "status": "SUCCESS",
      "details": {
        "npmInstall": "1012 packages, 0 vulnerabilities",
        "npmBuild": "TypeScript compilation successful",
        "backup": "Created functions/lib_backup/"
      }
    },
    {
      "step": 5,
      "action": "Delete obsolete functions",
      "status": "SUCCESS",
      "deletedFunctions": [
        "createCheckoutSession (us-central1)",
        "handleStripeWebhook (us-central1)",
        "closeAIChatCallable (europe-west3)",
        "listAICompanionsCallable (europe-west3)",
        "sendAIMessageCallable (europe-west3)",
        "startAIChatCallable (europe-west3)",
        "unlockAIGalleryCallable (europe-west3)"
      ]
    }
  ],
  "blockedActions": [
    {
      "step": 6,
      "action": "Firebase deployment",
      "status": "BLOCKED",
      "issue": "package-lock.json sync mismatch",
      "error": "Missing: picomatch@4.0.3 from lock file",
      "cloudBuildError": "npm ci requires exact sync between package.json and package-lock.json",
      "resolution": "Created .gcloudignore to exclude package-lock.json, forcing npm install in cloud"
    }
  ],
  "pendingActions": [
    {
      "step": 7,
      "action": "Verify endpoints",
      "status": "PENDING",
      "endpoints": [
        "https://europe-west3-avalo-c8c46.cloudfunctions.net/ping",
        "https://europe-west3-avalo-c8c46.cloudfunctions.net/getSystemInfo"
      ]
    },
    {
      "step": 8,
      "action": "Run integration tests",
      "status": "PENDING",
      "location": "tests/integration"
    }
  ],
  "nextSteps": [
    "Retry deployment with new .gcloudignore configuration",
    "Verify all endpoints return HTTP 200",
    "Run integration test suite",
    "Monitor Cloud Functions logs for errors",
    "Plan migration from functions.config() to dotenv"
  ],
  "filesCreated": [
    "fix-and-redeploy.ps1",
    "functions/.gcloudignore",
    "reports/redeploy_report.md",
    "reports/redeploy_report.json"
  ],
  "filesModified": [
    "functions/src/payments.ts",
    "functions/package-lock.json",
    "functions/lib/"
  ],
  "backups": [
    "functions/lib_backup/"
  ],
  "recommendations": {
    "immediate": [
      "Retry deployment: firebase deploy --only functions --project avalo-c8c46",
      "Monitor deployment in Firebase Console",
      "Test endpoints after successful deployment"
    ],
    "shortTerm": [
      "Review and commit functions/.gcloudignore to repository",
      "Update CI/CD pipeline to handle package-lock sync issues",
      "Document deployment procedures"
    ],
    "longTerm": [
      "Migrate from functions.config() to .env (deadline: March 2026)",
      "Implement automated deployment health checks",
      "Set up deployment rollback automation"
    ]
  },
  "knownIssues": [
    {
      "severity": "HIGH",
      "issue": "Package lock synchronization in Cloud Build",
      "impact": "Deployment blocked",
      "rootCause": "Local package-lock.json updates not reflected in Cloud Build cache",
      "workaround": "Exclude package-lock.json via .gcloudignore"
    },
    {
      "severity": "MEDIUM",
      "issue": "Legacy functions.config() API deprecated",
      "impact": "Will break after March 2026",
      "action": "Migrate to dotenv-based configuration"
    }
  ],
  "deployment": {
    "script": "fix-and-redeploy.ps1",
    "scriptStatus": "RUNNING",
    "buildAttempts": "20+",
    "buildStatus": "FAILING",
    "failureReason": "package-lock.json sync error"
  }
}