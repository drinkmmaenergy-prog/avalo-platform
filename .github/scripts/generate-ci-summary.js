#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const os = require('os');

// Ensure reports directory exists
const reportsDir = path.join(process.cwd(), 'reports');
if (!fs.existsSync(reportsDir)) {
  fs.mkdirSync(reportsDir, { recursive: true });
}

// Read existing test report if available
let testResults = null;
let testReportExists = false;

const testReportPath = path.join(reportsDir, 'avalo_full_test_report.json');
if (fs.existsSync(testReportPath)) {
  try {
    testResults = JSON.parse(fs.readFileSync(testReportPath, 'utf8'));
    testReportExists = true;
  } catch (error) {
    console.warn('‚ö†Ô∏è  Could not parse test report JSON:', error.message);
  }
}

// Gather CI environment info
const ciInfo = {
  timestamp: new Date().toISOString(),
  hostname: os.hostname(),
  platform: os.platform(),
  arch: os.arch(),
  nodeVersion: process.version,
  cwd: process.cwd(),
  githubSha: process.env.GITHUB_SHA || 'local',
  githubRef: process.env.GITHUB_REF || 'local',
  githubActor: process.env.GITHUB_ACTOR || 'local',
  runId: process.env.GITHUB_RUN_ID || 'local',
  runNumber: process.env.GITHUB_RUN_NUMBER || 'local'
};

// Emulator status badges
const emulators = {
  functions: testReportExists ? '‚úÖ' : '‚ö†Ô∏è',
  auth: testReportExists ? '‚úÖ' : '‚ö†Ô∏è',
  firestore: testReportExists ? '‚úÖ' : '‚ö†Ô∏è',
  hosting: testReportExists ? '‚úÖ' : '‚ö†Ô∏è',
  storage: testReportExists ? '‚úÖ' : '‚ö†Ô∏è'
};

// Calculate summary statistics
let totalTests = 0;
let passedTests = 0;
let failedTests = 0;
let duration = 0;
let overallStatus = 'unknown';

if (testResults) {
  totalTests = testResults.totalTests || 0;
  passedTests = testResults.passedTests || 0;
  failedTests = testResults.failedTests || 0;
  duration = testResults.duration || 0;
  overallStatus = failedTests === 0 ? 'passed' : 'failed';
}

// Generate markdown summary
const markdownSummary = `# üöÄ Avalo CI/CD Run Summary

## Overview
- **Status**: ${overallStatus === 'passed' ? '‚úÖ PASSED' : overallStatus === 'failed' ? '‚ùå FAILED' : '‚ö†Ô∏è  UNKNOWN'}
- **Timestamp**: ${ciInfo.timestamp}
- **Node Version**: ${ciInfo.nodeVersion}
- **Platform**: ${ciInfo.platform} (${ciInfo.arch})
- **Hostname**: ${ciInfo.hostname}

## GitHub Actions Info
- **SHA**: ${ciInfo.githubSha}
- **Ref**: ${ciInfo.githubRef}
- **Actor**: ${ciInfo.githubActor}
- **Run ID**: ${ciInfo.runId}
- **Run Number**: #${ciInfo.runNumber}

## Test Results
- **Total Tests**: ${totalTests}
- **Passed**: ${passedTests} ‚úÖ
- **Failed**: ${failedTests} ${failedTests > 0 ? '‚ùå' : ''}
- **Duration**: ${duration.toFixed(2)}s

## Firebase Emulator Status
| Emulator | Status |
|----------|--------|
| Functions | ${emulators.functions} |
| Authentication | ${emulators.auth} |
| Firestore | ${emulators.firestore} |
| Hosting | ${emulators.hosting} |
| Storage | ${emulators.storage} |

## Test Details
${testReportExists ? `
Full test report available in artifacts:
- \`reports/avalo_full_test_report.md\`
- \`reports/avalo_full_test_report.json\`
` : `
‚ö†Ô∏è  Test report files not found. Tests may not have executed properly.
`}

## Next Steps
${failedTests > 0 ? `
### üî¥ Action Required
Tests have failed. Please review the test report artifacts for details.

1. Download the test reports from GitHub Actions artifacts
2. Review failed test cases
3. Fix the issues in the codebase
4. Re-run the tests locally: \`npm test --prefix tests/integration\`
5. Push the fixes to trigger another CI run
` : testReportExists ? `
### ‚úÖ All Tests Passed
The build and all integration tests completed successfully. The code is ready for deployment.
` : `
### ‚ö†Ô∏è  Tests Incomplete
Test reports were not generated. Check the CI logs for emulator startup issues or test execution errors.
`}

---
*Generated by Avalo CI/CD Pipeline on ${new Date().toUTCString()}*
`;

// Generate JSON summary
const jsonSummary = {
  status: overallStatus,
  timestamp: ciInfo.timestamp,
  environment: {
    nodeVersion: ciInfo.nodeVersion,
    platform: ciInfo.platform,
    arch: ciInfo.arch,
    hostname: ciInfo.hostname
  },
  github: {
    sha: ciInfo.githubSha,
    ref: ciInfo.githubRef,
    actor: ciInfo.githubActor,
    runId: ciInfo.runId,
    runNumber: ciInfo.runNumber
  },
  tests: {
    total: totalTests,
    passed: passedTests,
    failed: failedTests,
    duration: duration
  },
  emulators: emulators,
  testReportExists: testReportExists
};

// Write markdown summary
const markdownPath = path.join(reportsDir, 'ci_run_summary.md');
fs.writeFileSync(markdownPath, markdownSummary, 'utf8');
console.log(`‚úÖ Generated: ${markdownPath}`);

// Write JSON summary
const jsonPath = path.join(reportsDir, 'ci_run_summary.json');
fs.writeFileSync(jsonPath, JSON.stringify(jsonSummary, null, 2), 'utf8');
console.log(`‚úÖ Generated: ${jsonPath}`);

// Console output
console.log('\n' + '='.repeat(80));
console.log('üìä CI RUN SUMMARY');
console.log('='.repeat(80));
console.log(`Status: ${overallStatus === 'passed' ? '‚úÖ PASSED' : overallStatus === 'failed' ? '‚ùå FAILED' : '‚ö†Ô∏è  UNKNOWN'}`);
console.log(`Tests: ${passedTests}/${totalTests} passed`);
console.log(`Duration: ${duration.toFixed(2)}s`);
console.log(`Node: ${ciInfo.nodeVersion}`);
console.log('='.repeat(80) + '\n');

// Exit with appropriate code
if (overallStatus === 'failed') {
  console.warn('‚ö†Ô∏è  Some tests failed. Review the reports for details.');
} else if (overallStatus === 'passed') {
  console.log('‚úÖ All tests passed successfully!');
} else {
  console.warn('‚ö†Ô∏è  Test status unknown. Review CI logs.');
}