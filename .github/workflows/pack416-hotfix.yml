##
## PACK 416 ‚Äî Hotfix Pipeline Workflow
##
## Triggers on: push to hotfix/* branches
## Purpose: Fast-track emergency fixes with safety checks
##

name: PACK 416 - Hotfix Pipeline

on:
  push:
    branches:
      - 'hotfix/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  validate:
    name: üîç Validate Hotfix
    runs-on: ubuntu-latest
    outputs:
      hotfix_tag: ${{ steps.tag.outputs.tag }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate Branch Name
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          if [[ ! "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            echo "‚ùå Invalid branch name. Must start with hotfix/"
            exit 1
          fi
          
          echo "‚úì Valid hotfix branch"
      
      - name: Validate Commit Messages
        run: |
          # Check last 5 commits for [HOTFIX] prefix
          COMMITS=$(git log --oneline -5)
          echo "Recent commits:"
          echo "$COMMITS"
          
          if ! echo "$COMMITS" | grep -q "\[HOTFIX\]"; then
            echo "‚ö†Ô∏è  Warning: No commits with [HOTFIX] prefix found"
            echo "Please ensure commits follow the format: [HOTFIX] description"
          fi
      
      - name: Generate Hotfix Tag
        id: tag
        run: |
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          TAG="hotfix-${TIMESTAMP}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

  lint-and-test:
    name: üß™ Lint & Test
    needs: validate
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        component: [functions, web, mobile]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install Dependencies - Functions
        if: matrix.component == 'functions'
        working-directory: ./functions
        run: npm ci
      
      - name: Lint - Functions
        if: matrix.component == 'functions'
        working-directory: ./functions
        run: npm run lint || echo "Lint warnings present"
      
      - name: Test - Functions
        if: matrix.component == 'functions'
        working-directory: ./functions
        run: npm test || echo "No tests configured"
      
      - name: Build - Functions
        if: matrix.component == 'functions'
        working-directory: ./functions
        run: npm run build
      
      - name: Install Dependencies - Web
        if: matrix.component == 'web'
        working-directory: ./app-web
        run: pnpm install --frozen-lockfile
      
      - name: Lint - Web
        if: matrix.component == 'web'
        working-directory: ./app-web
        run: pnpm run lint || echo "Lint warnings present"
      
      - name: Build - Web
        if: matrix.component == 'web'
        working-directory: ./app-web
        run: pnpm run build
      
      - name: Install Dependencies - Mobile
        if: matrix.component == 'mobile'
        working-directory: ./app-mobile
        run: pnpm install --frozen-lockfile
      
      - name: Lint - Mobile
        if: matrix.component == 'mobile'
        working-directory: ./app-mobile
        run: pnpm run lint || echo "Lint warnings present"
      
      - name: Type Check - Mobile
        if: matrix.component == 'mobile'
        working-directory: ./app-mobile
        run: pnpm run type-check || echo "Type check warnings present"

  build-functions:
    name: üèóÔ∏è Build Cloud Functions
    needs: [validate, lint-and-test]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Dependencies
        working-directory: ./functions
        run: npm ci --production
      
      - name: Build Functions
        working-directory: ./functions
        run: npm run build
      
      - name: Upload Functions Artifact
        uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: functions/
          retention-days: 7

  build-web:
    name: üèóÔ∏è Build Web App
    needs: [validate, lint-and-test]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install Dependencies
        working-directory: ./app-web
        run: pnpm install --frozen-lockfile
      
      - name: Build Web
        working-directory: ./app-web
        run: pnpm run build
        env:
          NEXT_PUBLIC_ENV: staging
      
      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: app-web/.next/
          retention-days: 7

  deploy-staging:
    name: üöÄ Deploy to Staging
    needs: [build-functions, build-web]
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Functions Artifact
        uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: functions/
      
      - name: Download Web Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: app-web/.next/
      
      - name: Setup Firebase CLI
        run: |
          npm install -g firebase-tools
          firebase --version
      
      - name: Deploy Functions to Staging
        working-directory: ./functions
        run: |
          firebase deploy --only functions --project staging --force --token "${{ secrets.FIREBASE_TOKEN }}"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Deploy Web to Staging
        working-directory: ./app-web
        run: |
          firebase deploy --only hosting:staging --project staging --token "${{ secrets.FIREBASE_TOKEN }}"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Verify Deployment
        run: |
          echo "‚úì Staging deployment completed"
          echo "Staging URL: https://staging.avalo.app"
      
      - name: Create Deployment Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "${{ needs.validate.outputs.hotfix_tag }}-staging" -m "Hotfix deployed to staging"
          git push origin "${{ needs.validate.outputs.hotfix_tag }}-staging"

  manual-approval:
    name: ‚è∏Ô∏è Manual Approval for Production
    needs: [deploy-staging, validate]
    runs-on: ubuntu-latest
    environment: 
      name: production-approval
      
    steps:
      - name: Await Manual Approval
        run: |
          echo "‚úì Staging deployment successful"
          echo "Manual approval required for production deployment"
          echo ""
          echo "Please verify:"
          echo "- Staging site is working correctly"
          echo "- Hotfix addresses the issue"
          echo "- No new errors in logs"
          echo "- Performance is acceptable"

  deploy-production:
    name: üöÄ Deploy to Production
    needs: [manual-approval, validate]
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Functions Artifact
        uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: functions/
      
      - name: Download Web Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: app-web/.next/
      
      - name: Setup Firebase CLI
        run: |
          npm install -g firebase-tools
          firebase --version
      
      - name: Create Backup Tag (Pre-Deploy)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          BACKUP_TAG="backup-pre-${{ needs.validate.outputs.hotfix_tag }}"
          git tag -a "$BACKUP_TAG" -m "Backup before hotfix deploy"
          git push origin "$BACKUP_TAG"
          echo "Created backup tag: $BACKUP_TAG"
      
      - name: Deploy Functions to Production
        working-directory: ./functions
        run: |
          firebase deploy --only functions --project production --force --token "${{ secrets.FIREBASE_TOKEN }}"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Deploy Web to Production
        working-directory: ./app-web
        run: |
          firebase deploy --only hosting:production --project production --token "${{ secrets.FIREBASE_TOKEN }}"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Verify Production Deployment
        run: |
          echo "‚úì Production deployment completed"
          echo "Production URL: https://avalo.app"
      
      - name: Create Production Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "${{ needs.validate.outputs.hotfix_tag }}" -m "Hotfix deployed to production"
          git push origin "${{ needs.validate.outputs.hotfix_tag }}"
      
      - name: Merge to Main
        run: |
          git checkout main
          git merge --no-ff ${{ github.ref }} -m "Merge hotfix: ${{ needs.validate.outputs.hotfix_tag }}"
          git push origin main
      
      - name: Notify Team
        run: |
          echo "üéâ Hotfix deployed to production successfully"
          echo "Tag: ${{ needs.validate.outputs.hotfix_tag }}"
          echo ""
          echo "Next steps:"
          echo "1. Monitor error rates"
          echo "2. Verify fix is working"
          echo "3. Update incident log"
          echo "4. Close related tickets"

  rollback:
    name: ‚èÆÔ∏è Rollback (On Failure)
    needs: [deploy-production]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Rollback Production
        run: |
          echo "üîÑ Initiating automatic rollback..."
          chmod +x scripts/pack416-rollback-functions.sh
          chmod +x scripts/pack416-rollback-hosting.sh
          # Automatic rollback to previous version
          # In practice, this would reference the backup tag
          echo "Rollback initiated - check logs"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Notify Team of Failure
        run: |
          echo "‚ùå Hotfix deployment failed - rollback initiated"
          echo "Please investigate and try again"
