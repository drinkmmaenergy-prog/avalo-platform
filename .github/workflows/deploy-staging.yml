name: Deploy to Staging

on:
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT: staging

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies (Functions)
        working-directory: ./functions
        run: npm ci
      
      - name: TypeScript check (Functions)
        working-directory: ./functions
        run: npx tsc --noEmit
      
      - name: Lint (Functions)
        working-directory: ./functions
        run: npm run lint || true
      
      - name: Unit tests
        working-directory: ./functions
        run: npm run test:unit
        env:
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
          FIRESTORE_EMULATOR_HOST: localhost:8080

  build-mobile:
    name: Build Mobile Apps
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Install dependencies
        working-directory: ./app-mobile
        run: npm ci
      
      - name: Configure environment
        working-directory: ./app-mobile
        run: |
          echo "REACT_APP_ENV=staging" >> .env
          echo "FIREBASE_STAGING_API_KEY=${{ secrets.FIREBASE_STAGING_API_KEY }}" >> .env
          echo "FIREBASE_STAGING_APP_ID=${{ secrets.FIREBASE_STAGING_APP_ID }}" >> .env
          echo "STRIPE_TEST_PUBLISHABLE_KEY=${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}" >> .env
      
      - name: Build Android (EAS)
        working-directory: ./app-mobile
        run: |
          npx eas-cli build --platform android --profile staging --non-interactive
        env:
          EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
      
      - name: Build iOS (EAS)
        working-directory: ./app-mobile
        run: |
          npx eas-cli build --platform ios --profile staging --non-interactive
        env:
          EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}

  build-web:
    name: Build Web App
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies (Web)
        working-directory: ./app-web
        run: npm ci
      
      - name: Configure environment
        working-directory: ./app-web
        run: |
          echo "NEXT_PUBLIC_ENV=staging" >> .env.production
          echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.FIREBASE_STAGING_API_KEY }}" >> .env.production
          echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.FIREBASE_STAGING_APP_ID }}" >> .env.production
          echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}" >> .env.production
      
      - name: Build Next.js
        working-directory: ./app-web
        run: npm run build
      
      - name: Export static site
        working-directory: ./app-web
        run: npm run export
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: app-web/out
          retention-days: 7

  deploy-firebase:
    name: Deploy Firebase
    runs-on: ubuntu-latest
    needs: [lint-and-test, build-web]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: app-web/out
      
      - name: Run database migrations
        run: node scripts/migrate-database.js --env=staging
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          FIREBASE_PROJECT: avalo-staging
      
      - name: Deploy Firestore rules
        run: firebase deploy --only firestore:rules --project=staging --token=${{ secrets.FIREBASE_TOKEN }}
      
      - name: Deploy Firestore indexes
        run: firebase deploy --only firestore:indexes --project=staging --token=${{ secrets.FIREBASE_TOKEN }}
      
      - name: Deploy Cloud Functions
        run: firebase deploy --only functions --project=staging --token=${{ secrets.FIREBASE_TOKEN }}
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_STAGING_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_STAGING_KEY }}
      
      - name: Deploy Web Hosting
        run: firebase deploy --only hosting:web --project=staging --token=${{ secrets.FIREBASE_TOKEN }}
      
      - name: Save deployment metadata
        run: |
          echo "{\"version\":\"${{ github.sha }}\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"environment\":\"staging\"}" > deployment-metadata.json
      
      - name: Upload deployment metadata
        uses: actions/upload-artifact@v4
        with:
          name: deployment-metadata
          path: deployment-metadata.json
          retention-days: 30

  smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-firebase
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: ./functions
        run: npm ci
      
      - name: Run smoke tests
        working-directory: ./functions
        run: npm run test:smoke
        env:
          TEST_ENV: staging
          FIREBASE_PROJECT: avalo-staging
          TEST_USER_EMAIL: ${{ secrets.STAGING_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.STAGING_TEST_USER_PASSWORD }}
      
      - name: Test Auth Flow
        run: node scripts/test-auth.js --env=staging
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_STAGING_API_KEY }}
      
      - name: Test Wallet Operations
        run: node scripts/test-wallet.js --env=staging
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_STAGING_API_KEY }}
          STRIPE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}
      
      - name: Test Chat Billing
        run: node scripts/test-chat-billing.js --env=staging
      
      - name: Test Calendar Booking
        run: node scripts/test-calendar.js --env=staging
      
      - name: Test AI Companion
        run: node scripts/test-ai-companion.js --env=staging
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: test-results/
          retention-days: 7

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-firebase, smoke-tests]
    if: always()
    
    steps:
      - name: Notify success
        if: success()
        run: |
          echo "✅ Staging deployment successful"
          # Add Slack/Discord/Email notification here
      
      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Staging deployment failed"
          # Add Slack/Discord/Email notification here
