name: Build Android

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        type: choice
        options:
          - development
          - preview
          - production

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '8.15.0'

jobs:
  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: ./app-mobile
        run: pnpm install --frozen-lockfile

      - name: Determine build profile
        id: profile
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=preview" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        working-directory: ./app-mobile
        run: pnpm test || echo "Tests not configured yet"

      - name: Build Android with EAS
        working-directory: ./app-mobile
        run: |
          eas build --platform android \
            --profile ${{ steps.profile.outputs.profile }} \
            --non-interactive \
            --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Get build ID
        id: build
        working-directory: ./app-mobile
        run: |
          BUILD_ID=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Build ID: $BUILD_ID"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Wait for build completion
        working-directory: ./app-mobile
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"
          echo "Waiting for build $BUILD_ID"
          
          TIMEOUT=1800  # 30 minutes
          ELAPSED=0
          INTERVAL=30
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status')
            echo "Build status: $STATUS (${ELAPSED}s elapsed)"
            
            if [[ "$STATUS" == "finished" ]]; then
              echo "âœ… Build completed successfully"
              exit 0
            elif [[ "$STATUS" == "errored" || "$STATUS" == "canceled" ]]; then
              echo "âŒ Build failed with status: $STATUS"
              eas build:view $BUILD_ID
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "âŒ Build timed out after ${TIMEOUT}s"
          exit 1
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download build artifact
        if: steps.profile.outputs.profile == 'production'
        working-directory: ./app-mobile
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"
          ARTIFACT_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl')
          
          if [[ "$ARTIFACT_URL" != "null" && -n "$ARTIFACT_URL" ]]; then
            echo "Downloading artifact from: $ARTIFACT_URL"
            curl -L -o app-release.aab "$ARTIFACT_URL"
            ls -lh app-release.aab
          else
            echo "âš ï¸ No artifact URL available"
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload artifact to GitHub
        if: steps.profile.outputs.profile == 'production' && hashFiles('app-mobile/app-release.aab') != ''
        uses: actions/upload-artifact@v3
        with:
          name: android-release-${{ github.sha }}
          path: app-mobile/app-release.aab
          retention-days: 30

      - name: Build summary
        run: |
          echo "### Android Build Summary ðŸ¤–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: ${{ steps.profile.outputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View build details: https://expo.dev/accounts/YOUR_ACCOUNT/projects/avalo/builds/${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY

  submit-android:
    name: Submit to Google Play
    runs-on: ubuntu-latest
    needs: [build-android]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to Google Play
        working-directory: ./app-mobile
        run: |
          eas submit --platform android \
            --latest \
            --profile production \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Notify submission success
        run: |
          echo "### Google Play Submission ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Android build submitted to Google Play Console" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review build in Google Play Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure release rollout percentage" >> $GITHUB_STEP_SUMMARY
          echo "3. Submit for review" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âœ… Android build submitted to Google Play",
              "blocks": [{
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Android Submission*\nâ€¢ Version: `${{ github.ref_name }}`\nâ€¢ Status: Submitted to Google Play Console"
                }
              }]
            }' || echo "Slack notification skipped"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "### Submission Failed âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Android build submission to Google Play failed." >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY