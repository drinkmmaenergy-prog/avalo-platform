name: Deploy to Production

on:
  push:
    branches:
      - release/*
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
      skip_tests:
        description: 'Skip tests (NOT RECOMMENDED)'
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT: production

jobs:
  verify-deployment:
    name: Verify Deployment Prerequisites
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify confirmation
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "‚ùå Deployment confirmation failed. You must type 'DEPLOY TO PRODUCTION' exactly."
            exit 1
          fi
      
      - name: Check branch protection
        run: |
          if [[ ! "${{ github.ref }}" =~ ^refs/heads/release/ ]] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "‚ùå Production deployments must be from release/* branches"
            exit 1
          fi

  compliance-check:
    name: Legal & Compliance Gate
    runs-on: ubuntu-latest
    needs: verify-deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check Terms & Privacy
        run: node scripts/check-legal-compliance.js
      
      - name: Verify 18+ gate
        run: node scripts/verify-age-gate.js
      
      - name: Verify KYC active
        run: node scripts/verify-kyc-active.js
        env:
          KYC_API_KEY: ${{ secrets.KYC_PROD_API_KEY }}
      
      - name: Verify Content Moderation enabled
        run: node scripts/verify-content-moderation.js
      
      - name: Verify Refund logic
        run: node scripts/verify-refund-logic.js
      
      - name: Generate compliance report
        run: |
          echo "‚úÖ All compliance checks passed" > compliance-report.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> compliance-report.txt
      
      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report.txt
          retention-days: 365

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: verify-deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security scan
        run: |
          echo "Running security scan..."
          # Add security scanning tools here (e.g., npm audit, Snyk)
      
      - name: Check for hardcoded secrets
        run: |
          if grep -r "AIzaSy" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "‚ùå Potential hardcoded API keys found!"
            exit 1
          fi
      
      - name: Validate Firebase config
        run: node scripts/validate-firebase-config.js --env=production

  lint-and-test:
    name: Lint & Full Test Suite
    runs-on: ubuntu-latest
    needs: [compliance-check, security-scan]
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies (Functions)
        working-directory: ./functions
        run: npm ci
      
      - name: TypeScript check (Functions)
        working-directory: ./functions
        run: npx tsc --noEmit
      
      - name: Lint (Functions)
        working-directory: ./functions
        run: npm run lint
      
      - name: Unit tests
        working-directory: ./functions
        run: npm run test:unit
      
      - name: Integration tests
        working-directory: ./functions
        run: npm run test:integration
        env:
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
          FIRESTORE_EMULATOR_HOST: localhost:8080

  build-mobile:
    name: Build Mobile Apps (Production)
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Install dependencies
        working-directory: ./app-mobile
        run: npm ci
      
      - name: Configure environment
        working-directory: ./app-mobile
        run: |
          echo "REACT_APP_ENV=production" >> .env
          echo "FIREBASE_PROD_API_KEY=${{ secrets.FIREBASE_PROD_API_KEY }}" >> .env
          echo "FIREBASE_PROD_APP_ID=${{ secrets.FIREBASE_PROD_APP_ID }}" >> .env
          echo "STRIPE_LIVE_PUBLISHABLE_KEY=${{ secrets.STRIPE_LIVE_PUBLISHABLE_KEY }}" >> .env
      
      - name: Build Android (Production)
        working-directory: ./app-mobile
        run: |
          npx eas-cli build --platform android --profile production --non-interactive
        env:
          EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
          GOOGLE_PLAY_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}
      
      - name: Build iOS (Production)
        working-directory: ./app-mobile
        run: |
          npx eas-cli build --platform ios --profile production --non-interactive
        env:
          EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
          APPLE_PRIVATE_KEY: ${{ secrets.APPLE_PRIVATE_KEY }}
      
      - name: Submit to Google Play (Internal Track)
        working-directory: ./app-mobile
        run: |
          npx eas-cli submit --platform android --latest --track internal
      
      - name: Submit to TestFlight
        working-directory: ./app-mobile
        run: |
          npx eas-cli submit --platform ios --latest

  build-web:
    name: Build Web App (Production)
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies (Web)
        working-directory: ./app-web
        run: npm ci
      
      - name: Configure environment
        working-directory: ./app-web
        run: |
          echo "NEXT_PUBLIC_ENV=production" >> .env.production
          echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.FIREBASE_PROD_API_KEY }}" >> .env.production
          echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.FIREBASE_PROD_APP_ID }}" >> .env.production
          echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_LIVE_PUBLISHABLE_KEY }}" >> .env.production
      
      - name: Build Next.js (Production)
        working-directory: ./app-web
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Export static site
        working-directory: ./app-web
        run: npm run export
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build-production
          path: app-web/out
          retention-days: 30

  backup-production:
    name: Backup Current Production
    runs-on: ubuntu-latest
    needs: [build-mobile, build-web]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Backup Firestore rules
        run: |
          firebase firestore:rules:get --project=production --token=${{ secrets.FIREBASE_TOKEN }} > backup-firestore-rules.txt
      
      - name: Backup Cloud Functions
        run: |
          firebase functions:config:get --project=production --token=${{ secrets.FIREBASE_TOKEN }} > backup-functions-config.json
      
      - name: Create backup metadata
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"${{ github.sha }}\",\"environment\":\"production\"}" > backup-metadata.json
      
      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-backup-${{ github.sha }}
          path: |
            backup-*.txt
            backup-*.json
          retention-days: 90

  deploy-database-migration:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: backup-production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check schema version
        run: node scripts/check-schema-version.js --env=production
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Run migrations
        run: node scripts/migrate-database.js --env=production --dry-run=false
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          FIREBASE_PROJECT: avalo-c8c46
      
      - name: Verify migration success
        run: node scripts/verify-migration.js --env=production

  manual-approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    needs: deploy-database-migration
    environment:
      name: production-approval
    
    steps:
      - name: Wait for approval
        run: echo "‚è≥ Waiting for manual approval to deploy to production..."

  deploy-firebase:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: manual-approval
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build-production
          path: app-web/out
      
      - name: Deploy Firestore rules
        run: firebase deploy --only firestore:rules --project=production --token=${{ secrets.FIREBASE_TOKEN }}
      
      - name: Deploy Firestore indexes
        run: firebase deploy --only firestore:indexes --project=production --token=${{ secrets.FIREBASE_TOKEN }}
      
      - name: Deploy Cloud Functions
        run: firebase deploy --only functions --project=production --token=${{ secrets.FIREBASE_TOKEN }}
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_LIVE_SECRET_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_PROD_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_PROD_KEY }}
          KYC_API_KEY: ${{ secrets.KYC_PROD_API_KEY }}
          SMS_API_KEY: ${{ secrets.SMS_PROD_API_KEY }}
          EMAIL_API_KEY: ${{ secrets.EMAIL_PROD_API_KEY }}
      
      - name: Deploy Web Hosting
        run: firebase deploy --only hosting:web --project=production --token=${{ secrets.FIREBASE_TOKEN }}
      
      - name: Save deployment metadata
        run: |
          echo "{\"version\":\"${{ github.sha }}\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"environment\":\"production\",\"deployed_by\":\"${{ github.actor }}\"}" > deployment-metadata-production.json
      
      - name: Upload deployment metadata
        uses: actions/upload-artifact@v4
        with:
          name: deployment-metadata-production
          path: deployment-metadata-production.json
          retention-days: 365

  smoke-tests:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-firebase
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        working-directory: ./functions
        run: npm ci
      
      - name: Wait for deployment to propagate
        run: sleep 60
      
      - name: Test Auth Flow
        run: node scripts/test-auth.js --env=production
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_PROD_API_KEY }}
      
      - name: Test Wallet Operations
        run: node scripts/test-wallet.js --env=production
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_PROD_API_KEY }}
          STRIPE_KEY: ${{ secrets.STRIPE_LIVE_PUBLISHABLE_KEY }}
      
      - name: Test Payment Processing
        run: node scripts/test-payments.js --env=production
      
      - name: Monitor error rates
        run: node scripts/monitor-errors.js --env=production --duration=300
      
      - name: Check feature flags
        run: node scripts/check-feature-flags.js --env=production

  rollback-on-failure:
    name: Auto-Rollback on Failure
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: failure()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Download backup artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-backup-${{ github.sha }}
      
      - name: Rollback Cloud Functions
        run: node scripts/rollback-functions.js --env=production
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Rollback Firestore rules
        run: |
          firebase firestore:rules:deploy backup-firestore-rules.txt --project=production --token=${{ secrets.FIREBASE_TOKEN }}
      
      - name: Rollback Web Hosting
        run: node scripts/rollback-hosting.js --env=production
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Notify rollback
        run: |
          echo "üîÑ ROLLBACK EXECUTED - Production deployment failed and was rolled back"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-firebase, smoke-tests]
    if: always()
    
    steps:
      - name: Notify success
        if: success()
        run: |
          echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL"
          echo "Version: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          # Add Slack/Discord/Email notification here
      
      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå PRODUCTION DEPLOYMENT FAILED"
          echo "Check logs and rollback status"
          # Add urgent Slack/Discord/Email notification here