rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isModerator() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Creator Independence Cases
    match /creator_independence_cases/{caseId} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        isModerator() ||
        resource.data.creatorId == request.auth.uid ||
        resource.data.reporterId == request.auth.uid
      );
      
      allow create: if isAuthenticated() && (
        request.resource.data.keys().hasAll([
          'creatorId', 'fanId', 'violationType', 'evidence',
          'status', 'severity', 'timestamp', 'reporterId'
        ]) &&
        request.resource.data.status == 'pending' &&
        request.resource.data.violationType in [
          'emotional_debt', 'ownership_claim', 'access_demand',
          'control_attempt', 'time_demand', 'financial_leverage',
          'guilt_pressure', 'jealousy_war', 'harassment'
        ] &&
        request.resource.data.severity in ['low', 'medium', 'high', 'critical'] &&
        request.resource.data.timestamp == request.time
      );
      
      allow update: if isAuthenticated() && (
        isModerator() ||
        (resource.data.creatorId == request.auth.uid && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'notes', 'resolution']))
      );
      
      allow delete: if isAdmin();
    }
    
    // Fan Entitlement Events
    match /fan_entitlement_events/{eventId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isModerator() ||
        resource.data.creatorId == request.auth.uid
      );
      
      allow create: if isAuthenticated() && (
        request.resource.data.keys().hasAll([
          'fanId', 'creatorId', 'eventType', 'messageContent',
          'severity', 'timestamp', 'autoDetected'
        ]) &&
        request.resource.data.eventType in [
          'emotional_debt', 'ownership_claim', 'access_demand',
          'control_attempt', 'time_demand', 'financial_leverage',
          'guilt_trip', 'jealousy_display', 'tracking_behavior'
        ] &&
        request.resource.data.severity in ['low', 'medium', 'high', 'critical'] &&
        request.resource.data.timestamp == request.time
      );
      
      allow update: if isModerator();
      allow delete: if isAdmin();
    }
    
    // Emotional Pressure Logs
    match /emotional_pressure_logs/{logId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isModerator() ||
        resource.data.creatorId == request.auth.uid ||
        resource.data.fanId == request.auth.uid
      );
      
      allow create: if isAuthenticated() && (
        request.resource.data.keys().hasAll([
          'fanId', 'creatorId', 'messageId', 'pressureType',
          'detected', 'blocked', 'timestamp'
        ]) &&
        request.resource.data.pressureType in [
          'guilt', 'obligation', 'debt', 'loyalty_demand',
          'access_pressure', 'attention_demand', 'exclusivity_request'
        ] &&
        request.resource.data.timestamp == request.time
      );
      
      allow update: if isModerator();
      allow delete: if isAdmin();
    }
    
    // Creator Boundary Settings
    match /creator_boundary_settings/{creatorId} {
      allow read: if isAuthenticated() && (
        isOwner(creatorId) ||
        isAdmin()
      );
      
      allow create, update: if isAuthenticated() && (
        isOwner(creatorId) &&
        request.resource.data.keys().hasAll([
          'creatorId', 'noEmotionalLabor', 'autoDeclineRomance',
          'autoBlockGuilt', 'professionalMode', 'showBoundaryBanner',
          'updatedAt'
        ]) &&
        request.resource.data.updatedAt == request.time
      );
      
      allow delete: if isAdmin();
    }
    
    // Fan Restriction Records
    match /fan_restriction_records/{recordId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isModerator() ||
        resource.data.fanId == request.auth.uid
      );
      
      allow create: if isAuthenticated() && (
        isModerator() &&
        request.resource.data.keys().hasAll([
          'fanId', 'creatorId', 'restrictionType', 'reason',
          'startTime', 'endTime', 'status', 'issuedBy'
        ]) &&
        request.resource.data.restrictionType in [
          'chat_cooldown', 'temporary_block', 'permanent_ban',
          'access_freeze', 'message_restriction'
        ] &&
        request.resource.data.status == 'active' &&
        request.resource.data.startTime == request.time
      );
      
      allow update: if isModerator();
      allow delete: if isAdmin();
    }
    
    // Creator Professional Templates
    match /creator_professional_templates/{creatorId} {
      allow read: if isAuthenticated() && isOwner(creatorId);
      
      allow create, update: if isAuthenticated() && (
        isOwner(creatorId) &&
        request.resource.data.creatorId == creatorId &&
        request.resource.data.templates is list &&
        request.resource.data.updatedAt == request.time
      );
      
      allow delete: if isAuthenticated() && isOwner(creatorId);
    }
  }
}