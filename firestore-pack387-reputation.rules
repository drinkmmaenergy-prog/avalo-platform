rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // PACK 387: Global PR, Reputation Intelligence & Crisis Response
    
    // Helper functions
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isExecutive() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'executive'];
    }
    
    function isLegal() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'executive', 'legal'];
    }
    
    function isStaff() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'executive', 'legal', 'support', 'moderator'];
    }
    
    // Reputation Signals - auto-generated by system, read by staff
    match /reputationSignals/{signalId} {
      allow read: if isStaff();
      allow create: if true; // System-generated
      allow update: if isAdmin(); // Admin can update threat levels manually
      allow delete: if isAdmin();
    }
    
    // PR Incidents - managed by staff, executives, and legal
    match /prIncidents/{incidentId} {
      allow read: if isStaff();
      allow create: if isStaff();
      allow update: if isStaff() || 
                       (isLegal() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['legalReview', 'legalApproval', 'legalNotes']));
      allow delete: if isAdmin();
    }
    
    // Public Statements - requires legal approval
    match /publicStatements/{statementId} {
      allow read: if isStaff();
      allow create: if isStaff();
      allow update: if (isStaff() && resource.data.status == 'DRAFT') ||
                       (isLegal() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['legalApproval', 'legalNotes'])) ||
                       (isExecutive() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['executiveApproval', 'executiveNotes'])) ||
                       (isAdmin() && resource.data.status == 'APPROVED' && request.resource.data.status == 'PUBLISHED');
      allow delete: if isAdmin() && resource.data.status == 'DRAFT';
    }
    
    // Crisis Response Logs - system generated, read by staff
    match /crisisResponseLogs/{logId} {
      allow read: if isStaff();
      allow create: if true; // System-generated
      allow update: if false; // Immutable
      allow delete: if false; // Never delete crisis logs
    }
    
    // Store Crisis Shields - system managed
    match /storeCrisisShields/{shieldId} {
      allow read: if isStaff();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Influencer Risk Scores - system calculated
    match /influencerRiskScores/{influencerId} {
      allow read: if isStaff();
      allow create: if true; // System-generated
      allow update: if true; // System-updated
      allow delete: if isAdmin();
    }
    
    // Sentiment Analytics - aggregated data
    match /sentimentAnalytics/{analyticId} {
      allow read: if isStaff();
      allow create: if true; // System-generated
      allow update: if true; // System-updated
      allow delete: if isAdmin();
    }
    
    // Crisis Playbooks - predefined response templates
    match /crisisPlaybooks/{playbookId} {
      allow read: if isStaff();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}
