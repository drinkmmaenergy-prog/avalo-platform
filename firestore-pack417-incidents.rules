rules_version = '2';

/**
 * PACK 417 â€” Incident Response, On-Call & Postmortem Engine
 * 
 * Security rules for incident management, timeline, action items, and postmortems.
 * Integrates with PACK 296/300A admin roles.
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for role checking (assumed from PACK 296/300A)
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }
    
    function isAdmin() {
      return hasAnyRole(['SUPER_ADMIN', 'ADMIN', 'PLATFORM_ADMIN']);
    }
    
    function isSafetyRole() {
      return hasAnyRole(['SUPER_ADMIN', 'ADMIN', 'SAFETY_MODERATOR', 'SAFETY_LEAD']);
    }
    
    function isFraudRole() {
      return hasAnyRole(['SUPER_ADMIN', 'ADMIN', 'FRAUD_ANALYST']);
    }
    
    function isSupportRole() {
      return hasAnyRole(['SUPER_ADMIN', 'ADMIN', 'SUPPORT_LEAD', 'SUPPORT_AGENT']);
    }
    
    function canReadIncidents() {
      return isAdmin() || isSafetyRole() || isFraudRole() || isSupportRole();
    }
    
    function canReadIncident(incident) {
      // Admins can read all incidents
      if (isAdmin()) {
        return true;
      }
      
      // Safety roles can read safety-related incidents
      if (isSafetyRole() && incident.safetyRelated == true) {
        return true;
      }
      
      // Fraud roles can read fraud-related incidents
      if (isFraudRole() && incident.fraudRelated == true) {
        return true;
      }
      
      // Support can read incidents from support tickets
      if (isSupportRole() && incident.source == 'SUPPORT_TICKET') {
        return true;
      }
      
      // Filter by severity - support roles can only see SEV2/SEV3
      if (isSupportRole() && incident.severity in ['SEV2', 'SEV3']) {
        return true;
      }
      
      return false;
    }
    
    // Incidents collection
    match /incidents/{incidentId} {
      // Read: Admin and specialized roles with filtering
      allow read: if canReadIncidents() && canReadIncident(resource.data);
      
      // Write: Only through Cloud Functions (no direct client writes)
      allow write: if false;
      
      // Timeline subcollection
      match /timeline/{timelineId} {
        // Read: Same as parent incident
        allow read: if canReadIncidents() && 
          canReadIncident(get(/databases/$(database)/documents/incidents/$(incidentId)).data);
        
        // Write: Only through Cloud Functions
        allow write: if false;
      }
      
      // Action items subcollection
      match /actions/{actionId} {
        // Read: Same as parent incident
        allow read: if canReadIncidents() && 
          canReadIncident(get(/databases/$(database)/documents/incidents/$(incidentId)).data);
        
        // Write: Only through Cloud Functions
        allow write: if false;
      }
    }
    
    // Incident postmortems
    match /incidentPostmortems/{incidentId} {
      // Read: Admin, safety, and fraud roles only
      allow read: if isAdmin() || isSafetyRole() || isFraudRole();
      
      // Write: Only admin roles, and only when incident requires postmortem
      allow create: if isAdmin() && 
        get(/databases/$(database)/documents/incidents/$(incidentId)).data.status in ['POSTMORTEM_REQUIRED', 'POSTMORTEM_COMPLETE'];
      
      allow update: if isAdmin() && 
        get(/databases/$(database)/documents/incidents/$(incidentId)).data.status in ['POSTMORTEM_REQUIRED', 'POSTMORTEM_COMPLETE'];
      
      // Delete: Only through Cloud Functions
      allow delete: if false;
    }
    
    // On-call configuration
    match /onCallConfig/{configId} {
      // Read: All authenticated users can see who's on-call
      allow read: if isAuthenticated();
      
      // Write: Only admins can update on-call rotation
      allow write: if isAdmin();
    }
  }
}
